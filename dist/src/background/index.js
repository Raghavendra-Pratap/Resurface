(function(){"use strict";const L=(e,t)=>t.some(n=>e instanceof n);let G,F;function te(){return G||(G=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function ne(){return F||(F=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const x=new WeakMap,M=new WeakMap,T=new WeakMap;function oe(e){const t=new Promise((n,o)=>{const a=()=>{e.removeEventListener("success",s),e.removeEventListener("error",r)},s=()=>{n(g(e.result)),a()},r=()=>{o(e.error),a()};e.addEventListener("success",s),e.addEventListener("error",r)});return T.set(t,e),t}function ae(e){if(x.has(e))return;const t=new Promise((n,o)=>{const a=()=>{e.removeEventListener("complete",s),e.removeEventListener("error",r),e.removeEventListener("abort",r)},s=()=>{n(),a()},r=()=>{o(e.error||new DOMException("AbortError","AbortError")),a()};e.addEventListener("complete",s),e.addEventListener("error",r),e.addEventListener("abort",r)});x.set(e,t)}let O={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return x.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return g(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function $(e){O=e(O)}function se(e){return ne().includes(e)?function(...t){return e.apply(U(this),t),g(this.request)}:function(...t){return g(e.apply(U(this),t))}}function re(e){return typeof e=="function"?se(e):(e instanceof IDBTransaction&&ae(e),L(e,te())?new Proxy(e,O):e)}function g(e){if(e instanceof IDBRequest)return oe(e);if(M.has(e))return M.get(e);const t=re(e);return t!==e&&(M.set(e,t),T.set(t,e)),t}const U=e=>T.get(e);function ie(e,t,{blocked:n,upgrade:o,blocking:a,terminated:s}={}){const r=indexedDB.open(e,t),d=g(r);return o&&r.addEventListener("upgradeneeded",c=>{o(g(r.result),c.oldVersion,c.newVersion,g(r.transaction),c)}),n&&r.addEventListener("blocked",c=>n(c.oldVersion,c.newVersion,c)),d.then(c=>{s&&c.addEventListener("close",()=>s()),a&&c.addEventListener("versionchange",i=>a(i.oldVersion,i.newVersion,i))}).catch(()=>{}),d}const ce=["get","getKey","getAll","getAllKeys","count"],de=["put","add","delete","clear"],_=new Map;function H(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(_.get(t))return _.get(t);const n=t.replace(/FromIndex$/,""),o=t!==n,a=de.includes(n);if(!(n in(o?IDBIndex:IDBObjectStore).prototype)||!(a||ce.includes(n)))return;const s=async function(r,...d){const c=this.transaction(r,a?"readwrite":"readonly");let i=c.store;return o&&(i=i.index(d.shift())),(await Promise.all([i[n](...d),a&&c.done]))[0]};return _.set(t,s),s}$(e=>({...e,get:(t,n,o)=>H(t,n)||e.get(t,n,o),has:(t,n)=>!!H(t,n)||e.has(t,n)}));const ue=["continue","continuePrimaryKey","advance"],K={},B=new WeakMap,q=new WeakMap,le={get(e,t){if(!ue.includes(t))return e[t];let n=K[t];return n||(n=K[t]=function(...o){B.set(this,q.get(this)[t](...o))}),n}};async function*fe(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;t=t;const n=new Proxy(t,le);for(q.set(n,t),T.set(n,U(t));t;)yield n,t=await(B.get(n)||t.continue()),B.delete(n)}function z(e,t){return t===Symbol.asyncIterator&&L(e,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&L(e,[IDBIndex,IDBObjectStore])}$(e=>({...e,get(t,n,o){return z(t,n)?fe:e.get(t,n,o)},has(t,n){return z(t,n)||e.has(t,n)}}));const me=[{name:"Read Later",emoji:"üìñ"},{name:"Reference",emoji:"üìå"},{name:"Share",emoji:"üîó"},{name:"Project",emoji:"üìÅ"}],ge=["#818cf8","#34d399","#fbbf24","#f87171","#38bdf8","#a78bfa","#fb7185","#2dd4bf"],P={"github.com":"Development","gitlab.com":"Development","stackoverflow.com":"Development","dev.to":"Development","npmjs.com":"Development","docs.python.org":"Development","developer.mozilla.org":"Development","medium.com":"Articles","substack.com":"Articles","hashnode.com":"Articles","blog.":"Articles","youtube.com":"Videos","vimeo.com":"Videos","twitch.tv":"Videos","twitter.com":"Social","x.com":"Social","linkedin.com":"Social","reddit.com":"Social","facebook.com":"Social","news.ycombinator.com":"Tech News","techcrunch.com":"Tech News","theverge.com":"Tech News","arstechnica.com":"Tech News","wired.com":"Tech News","arxiv.org":"Research","scholar.google.com":"Research","researchgate.net":"Research","nature.com":"Research","sciencedirect.com":"Research","figma.com":"Design","dribbble.com":"Design","behance.net":"Design","awwwards.com":"Design","openai.com":"AI","anthropic.com":"AI","huggingface.co":"AI"},k=3,he="resurface",we=1,pe=new Set(["the","a","an","and","or","but","in","on","at","to","for","of","with","by","from","is","are","was","were","be","been","being","have","has","had","do","does","did","will","would","could","should","may","might","must","shall","can","need","how","what","when","where","why","who","which","this","that","these","those","i","you","he","she","it","we","they","my","your","his","her","its","our","their","me","him","us","them","just","only","also","very","too","so","than","then","now","here","there","all","each","every","both","few","more","most","other","some","such","no","not","any","new","first","last","long","great","little","own","same","right","big","high","different","small","large","next","early","young","important","public","bad","good","best","well","way","use","using","used","get","getting","got","make","making","made","part","full","complete","guide","tutorial","introduction","intro","overview"]);let v;const ye=new Uint8Array(16);function Ie(){if(!v&&(v=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!v))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return v(ye)}const l=[];for(let e=0;e<256;++e)l.push((e+256).toString(16).slice(1));function be(e,t=0){return l[e[t+0]]+l[e[t+1]]+l[e[t+2]]+l[e[t+3]]+"-"+l[e[t+4]]+l[e[t+5]]+"-"+l[e[t+6]]+l[e[t+7]]+"-"+l[e[t+8]]+l[e[t+9]]+"-"+l[e[t+10]]+l[e[t+11]]+l[e[t+12]]+l[e[t+13]]+l[e[t+14]]+l[e[t+15]]}const J={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function Se(e,t,n){if(J.randomUUID&&!e)return J.randomUUID();e=e||{};const o=e.random||(e.rng||Ie)();return o[6]=o[6]&15|64,o[8]=o[8]&63|128,be(o)}function D(){return Se()}function h(){return Date.now()}function y(e){try{const{hostname:t}=new URL(e);return t.replace("www.","")}catch{return""}}function Q(e){return e.toLowerCase().replace(/[^a-z0-9\s]/g," ").split(/\s+/).filter(t=>t.length>2&&!pe.has(t)&&!/^\d+$/.test(t)).slice(0,5)}function Te(e){return e.charAt(0).toUpperCase()+e.slice(1)}function N(e){const t=Math.floor((Date.now()-e)/1e3);if(t<60)return"Just now";const n=Math.floor(t/60);if(n<60)return`${n}m ago`;const o=Math.floor(n/60);if(o<24)return`${o}h ago`;const a=Math.floor(o/24);if(a<7)return`${a}d ago`;const s=Math.floor(a/7);if(s<4)return`${s}w ago`;const r=Math.floor(a/30);return r<12?`${r}mo ago`:`${Math.floor(a/365)}y ago`}function ve(e,t,n){return[e.toLowerCase(),t.toLowerCase(),(n==null?void 0:n.toLowerCase())||""].join(" ").trim()}function De(e,t){const n=e.filter(o=>!t.includes(o));return n.length===0?e[Math.floor(Math.random()*e.length)]:n[Math.floor(Math.random()*n.length)]}let p=null;async function f(){return console.log("Resurface Storage: ensureDb called, db exists:",!!p),p||(console.log("Resurface Storage: DB not initialized, calling initStorage..."),await j(),console.log("Resurface Storage: initStorage completed, db exists:",!!p)),p}async function j(){p||(p=await ie(he,we,{upgrade(e){const t=e.createObjectStore("savedItems",{keyPath:"id"});t.createIndex("by-url","url"),t.createIndex("by-savedAt","savedAt"),t.createIndex("by-searchText","searchText"),e.createObjectStore("topics",{keyPath:"id"}).createIndex("by-name","name"),e.createObjectStore("intents",{keyPath:"id"}).createIndex("by-name","name"),e.createObjectStore("settings",{keyPath:"id"})}}),await Ae())}async function Ae(){const e=await f();if((await e.getAll("intents")).length===0)for(const o of me)await e.add("intents",{id:D(),name:o.name,emoji:o.emoji,createdAt:h(),itemCount:0});await e.get("settings","main")||await e.add("settings",{id:"main",keyboardShortcut:"Cmd+Shift+S",autoSaveDelay:5e3,showResurfaceDropdown:!0,defaultIntentId:null})}async function Ee(e){console.log("Resurface Storage: saveItem called with:",e.url);try{const t=await f();console.log("Resurface Storage: Got database reference"),console.log("Resurface Storage: Checking for existing item with URL:",e.url);const n=await t.getFromIndex("savedItems","by-url",e.url);if(console.log("Resurface Storage: Existing item found:",!!n),n){console.log("Resurface Storage: Updating existing item");const o={...n,...e,id:n.id,savedAt:n.savedAt,lastAccessedAt:h()};return await t.put("savedItems",o),console.log("Resurface Storage: Item updated successfully"),o}return console.log("Resurface Storage: Adding new item..."),await t.add("savedItems",e),console.log("Resurface Storage: Item added to database"),console.log("Resurface Storage: Updating topic counts for:",e.topicIds),await R(e.topicIds,1),console.log("Resurface Storage: Updating intent counts for:",e.intentIds),await C(e.intentIds,1),console.log("Resurface Storage: saveItem completed successfully"),e}catch(t){throw console.error("Resurface Storage: Error in saveItem:",t),t}}async function Re(e){return(await f()).getFromIndex("savedItems","by-url",e)}async function X(){return(await(await f()).getAll("savedItems")).sort((n,o)=>o.savedAt-n.savedAt)}async function A(e,t=10){const n=await f(),o=e.toLowerCase().trim();if(!o)return[];const a=await n.getAll("savedItems"),s=o.split(/\s+/);return a.filter(r=>s.some(d=>r.searchText.includes(d))).sort((r,d)=>{const c=s.filter(u=>r.searchText.includes(u)).length,i=s.filter(u=>d.searchText.includes(u)).length;return i!==c?i-c:d.savedAt-r.savedAt}).slice(0,t)}async function Ce(e,t){const n=await f(),o=await n.get("savedItems",e);if(!o)return null;const a=o.topicIds,s=o.intentIds,r={...o,...t,lastAccessedAt:h()};if(await n.put("savedItems",r),t.topicIds){const d=a.filter(i=>!t.topicIds.includes(i)),c=t.topicIds.filter(i=>!a.includes(i));await R(d,-1),await R(c,1)}if(t.intentIds){const d=s.filter(i=>!t.intentIds.includes(i)),c=t.intentIds.filter(i=>!s.includes(i));await C(d,-1),await C(c,1)}return r}async function Le(e){const t=await f(),n=await t.get("savedItems",e);return n?(await t.delete("savedItems",e),await R(n.topicIds,-1),await C(n.intentIds,-1),!0):!1}async function I(){return(await(await f()).getAll("topics")).sort((n,o)=>o.itemCount-n.itemCount)}async function E(e,t=!1){const n=await f(),o=e.trim(),a=await n.getFromIndex("topics","by-name",o);if(a)return a;const r=(await n.getAll("topics")).map(c=>c.color),d={id:D(),name:o,color:De(ge,r),isAutoGenerated:t,createdAt:h(),itemCount:0};return await n.add("topics",d),d}async function xe(e){return E(e,!1)}async function R(e,t){const n=await f();for(const o of e){const a=await n.get("topics",o);a&&(a.itemCount=Math.max(0,a.itemCount+t),await n.put("topics",a))}}async function b(){return(await(await f()).getAll("intents")).sort((n,o)=>o.itemCount-n.itemCount)}async function Me(e,t){const n=await f(),o={id:D(),name:e.trim(),emoji:t,createdAt:h(),itemCount:0};return await n.add("intents",o),o}async function C(e,t){const n=await f();for(const o of e){const a=await n.get("intents",o);a&&(a.itemCount=Math.max(0,a.itemCount+t),await n.put("intents",a))}}async function S(){return await(await f()).get("settings","main")}async function Y(e){const t=await f(),o={...await S(),...e};return await t.put("settings",o),o}async function Oe(e){const t=[],n=new Set,o=await Ue(e.url);o&&!n.has(o.name.toLowerCase())&&(t.push(o),n.add(o.name.toLowerCase()));const a=await I(),s=Q(e.title),r=e.referrerQuery?Q(e.referrerQuery):[],d=[...new Set([...r,...s])];for(const c of d){if(t.length>=k)break;const i=_e(c,a);i&&!n.has(i.name.toLowerCase())&&(t.push(i),n.add(i.name.toLowerCase()))}if(t.length<k&&d.length>0)for(const c of d){if(t.length>=k)break;const i=Te(c);if(!n.has(i.toLowerCase())&&c.length>=3&&Be(c)){const u=await E(i,!0);t.push(u),n.add(i.toLowerCase())}}return t}async function Ue(e){const t=y(e);if(P[t])return E(P[t],!0);for(const[n,o]of Object.entries(P))if(n.endsWith(".")&&t.includes(n))return E(o,!0);return null}function _e(e,t){const n=e.toLowerCase(),o=t.find(s=>s.name.toLowerCase()===n);if(o)return o;const a=t.find(s=>{const r=s.name.toLowerCase();return r.includes(n)||n.includes(r)});return a||null}function Be(e){return!(e.length<3||new Set(["app","web","site","page","post","blog","news","article","home","about","contact","help","faq","terms","privacy","login","signup","register","account","profile","settings","search","results","list","view","edit","create","delete","file","files","folder","document","image","video","audio","free","pro","premium","trial","demo","beta","alpha","online","digital","virtual","mobile","desktop","cloud"]).has(e.toLowerCase())||/^\d+$/.test(e))}function Pe(e,t){return{type:e,payload:t}}async function m(e,t,n){return chrome.tabs.sendMessage(e,Pe(t,n))}chrome.runtime.onInstalled.addListener(async()=>{await j(),await W(),console.log("Resurface installed and initialized")}),chrome.runtime.onStartup.addListener(async()=>{await j(),await W(),console.log("Resurface started")});async function W(){const t=(await chrome.commands.getAll()).find(n=>n.name==="save-tab");t!=null&&t.shortcut&&await Y({keyboardShortcut:t.shortcut})}chrome.commands.onCommand.addListener(async e=>{e==="save-tab"?await V():e==="resurface"&&await ke()}),chrome.omnibox.onInputChanged.addListener(async(e,t)=>{if(e.length<2){t([]);return}const o=(await A(e,6)).map(a=>({content:a.url,description:`<match>${Z(a.title)}</match> <dim>- ${Z(y(a.url))}</dim>`}));t(o)}),chrome.omnibox.onInputEntered.addListener(async(e,t)=>{let n;switch(e.startsWith("http://")||e.startsWith("https://")?n=e:n=chrome.runtime.getURL(`src/dashboard/index.html?search=${encodeURIComponent(e)}`),t){case"currentTab":chrome.tabs.update({url:n});break;case"newForegroundTab":chrome.tabs.create({url:n});break;case"newBackgroundTab":chrome.tabs.create({url:n,active:!1});break}});function Z(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}chrome.action.onClicked.addListener(async e=>{e.id&&await V()});async function ee(e){try{await chrome.tabs.sendMessage(e,{type:"PING"})}catch{console.log("Content script not found, injecting..."),await chrome.scripting.executeScript({target:{tabId:e},files:["src/content/index.js"]}),await chrome.scripting.insertCSS({target:{tabId:e},files:["src/content/styles.css"]}),await new Promise(t=>setTimeout(t,100))}}async function ke(){const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!(e!=null&&e.id)||!e.url){console.log("No active tab or URL");return}if(!e.url.startsWith("http://")&&!e.url.startsWith("https://")){chrome.tabs.create({url:chrome.runtime.getURL("src/dashboard/index.html")});return}try{await ee(e.id);const t=await X(),n=await I(),o=await b(),a=t.slice(0,20).map(s=>({id:s.id,title:s.title,url:s.url,favicon:s.favicon,faviconType:s.faviconType,domain:y(s.url),savedAt:N(s.savedAt),topics:n.filter(r=>s.topicIds.includes(r.id)),intents:o.filter(r=>s.intentIds.includes(r.id))}));await m(e.id,"SHOW_SEARCH_MODAL",{items:a})}catch(t){console.error("Error in resurface command:",t)}}async function V(){const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!(e!=null&&e.id)||!e.url){console.log("No active tab or URL");return}if(!e.url.startsWith("http://")&&!e.url.startsWith("https://")){console.log("Cannot save restricted URL:",e.url);return}try{await ee(e.id);const t=await Re(e.url);if(t){await m(e.id,"SHOW_ALREADY_SAVED",{item:t});return}const n=await m(e.id,"EXTRACT_PAGE"),a=(await chrome.tabs.query({windowId:e.windowId})).filter(i=>{var u;return i.id!==e.id&&((u=i.url)==null?void 0:u.startsWith("http"))}).map(i=>i.url).slice(0,10),s=await Oe({url:n.url,title:n.title,referrerQuery:n.referrerQuery}),r=await b(),d=await S(),c={pageData:n,suggestedTopics:s,intents:r,siblingTabUrls:a,autoSaveDelay:d.autoSaveDelay};m(e.id,"SHOW_TOAST",c).catch(i=>{console.error("Error showing toast:",i)})}catch(t){console.error("Error in save command:",t)}}chrome.runtime.onMessage.addListener((e,t,n)=>{const o=Ne[e.type];return o?(o(e.payload,t).then(n).catch(a=>{console.error(`Error handling ${e.type}:`,a),n({error:a.message})}),!0):(console.warn("Unknown message type:",e.type),!1)});const Ne={async SAVE_ITEM(e){console.log("Resurface Background: ========== SAVE_ITEM RECEIVED =========="),console.log("Resurface Background: Payload:",JSON.stringify(e,null,2));try{const{pageData:t,toastResult:n,siblingTabUrls:o}=e;console.log("Resurface Background: Creating item object...");const a={id:D(),url:t.url,title:n.title,favicon:t.favicon,faviconType:t.faviconType,savedAt:h(),lastAccessedAt:h(),referrerQuery:t.referrerQuery,referrerUrl:t.referrerUrl,siblingTabUrls:o,topicIds:n.topicIds,intentIds:n.intentIds,searchText:ve(n.title,t.url,t.referrerQuery)};console.log("Resurface Background: Item created:",JSON.stringify(a,null,2)),console.log("Resurface Background: Calling saveItem...");const s=await Ee(a);return console.log("Resurface Background: ========== ITEM SAVED SUCCESSFULLY =========="),console.log("Resurface Background: Saved item:",JSON.stringify(s,null,2)),s}catch(t){throw console.error("Resurface Background: ========== SAVE_ITEM ERROR =========="),console.error("Resurface Background: Error:",t),t}},async SEARCH_ITEMS(e){return A(e.query)},async GET_ALL_ITEMS(){return X()},async GET_ALL_TOPICS(){return I()},async GET_ALL_INTENTS(){return b()},async DELETE_ITEM(e){return Le(e.id)},async UPDATE_ITEM(e){return Ce(e.id,e.updates)},async CREATE_TOPIC(e){return xe(e.name)},async CREATE_INTENT(e){return Me(e.name,e.emoji)},async URL_INPUT(e,t){var r;const{query:n}=e,o=(r=t.tab)==null?void 0:r.id;if(!o||!(await S()).showResurfaceDropdown)return;if(n.length<2){await m(o,"HIDE_DROPDOWN");return}const s=await A(n,5);if(s.length>0){const d=await I(),c=await b(),i=s.map(u=>({id:u.id,title:u.title,url:u.url,favicon:u.favicon,faviconType:u.faviconType,domain:y(u.url),savedAt:N(u.savedAt),topics:d.filter(w=>u.topicIds.includes(w.id)),intents:c.filter(w=>u.intentIds.includes(w.id))}));await m(o,"SHOW_DROPDOWN",{items:i})}else await m(o,"HIDE_DROPDOWN")},async TRIGGER_SAVE(){await V()},async GET_SETTINGS(){return await W(),S()},async UPDATE_SETTINGS(e){return Y(e)}};chrome.tabs.onUpdated.addListener(async(e,t,n)=>{if(t.status==="complete"&&n.url){if(!(await S()).showResurfaceDropdown)return;const a=n.url.match(/google\.[a-z.]+\/search\?.*q=([^&]+)/);if(a){const s=decodeURIComponent(a[1].replace(/\+/g," ")),r=await A(s,5);if(r.length>0)try{const d=await I(),c=await b(),i=r.map(u=>({id:u.id,title:u.title,url:u.url,favicon:u.favicon,faviconType:u.faviconType,domain:y(u.url),savedAt:N(u.savedAt),topics:d.filter(w=>u.topicIds.includes(w.id)),intents:c.filter(w=>u.intentIds.includes(w.id))}));await m(e,"SHOW_GOOGLE_OVERLAY",{items:i,query:s})}catch{}}}})})();
