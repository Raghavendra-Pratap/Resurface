(function(){"use strict";const M=(t,e)=>e.some(n=>t instanceof n);let H,q;function ut(){return H||(H=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function gt(){return q||(q=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const O=new WeakMap,N=new WeakMap,A=new WeakMap;function mt(t){const e=new Promise((n,o)=>{const s=()=>{t.removeEventListener("success",i),t.removeEventListener("error",a)},i=()=>{n(h(t.result)),s()},a=()=>{o(t.error),s()};t.addEventListener("success",i),t.addEventListener("error",a)});return A.set(e,t),e}function ft(t){if(O.has(t))return;const e=new Promise((n,o)=>{const s=()=>{t.removeEventListener("complete",i),t.removeEventListener("error",a),t.removeEventListener("abort",a)},i=()=>{n(),s()},a=()=>{o(t.error||new DOMException("AbortError","AbortError")),s()};t.addEventListener("complete",i),t.addEventListener("error",a),t.addEventListener("abort",a)});O.set(t,e)}let _={get(t,e,n){if(t instanceof IDBTransaction){if(e==="done")return O.get(t);if(e==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return h(t[e])},set(t,e,n){return t[e]=n,!0},has(t,e){return t instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in t}};function z(t){_=t(_)}function wt(t){return gt().includes(t)?function(...e){return t.apply(k(this),e),h(this.request)}:function(...e){return h(t.apply(k(this),e))}}function ht(t){return typeof t=="function"?wt(t):(t instanceof IDBTransaction&&ft(t),M(t,ut())?new Proxy(t,_):t)}function h(t){if(t instanceof IDBRequest)return mt(t);if(N.has(t))return N.get(t);const e=ht(t);return e!==t&&(N.set(t,e),A.set(e,t)),e}const k=t=>A.get(t);function D(t,e,{blocked:n,upgrade:o,blocking:s,terminated:i}={}){const a=indexedDB.open(t,e),l=h(a);return o&&a.addEventListener("upgradeneeded",d=>{o(h(a.result),d.oldVersion,d.newVersion,h(a.transaction),d)}),n&&a.addEventListener("blocked",d=>n(d.oldVersion,d.newVersion,d)),l.then(d=>{i&&d.addEventListener("close",()=>i()),s&&d.addEventListener("versionchange",c=>s(c.oldVersion,c.newVersion,c))}).catch(()=>{}),l}const pt=["get","getKey","getAll","getAllKeys","count"],yt=["put","add","delete","clear"],P=new Map;function Q(t,e){if(!(t instanceof IDBDatabase&&!(e in t)&&typeof e=="string"))return;if(P.get(e))return P.get(e);const n=e.replace(/FromIndex$/,""),o=e!==n,s=yt.includes(n);if(!(n in(o?IDBIndex:IDBObjectStore).prototype)||!(s||pt.includes(n)))return;const i=async function(a,...l){const d=this.transaction(a,s?"readwrite":"readonly");let c=d.store;return o&&(c=c.index(l.shift())),(await Promise.all([c[n](...l),s&&d.done]))[0]};return P.set(e,i),i}z(t=>({...t,get:(e,n,o)=>Q(e,n)||t.get(e,n,o),has:(e,n)=>!!Q(e,n)||t.has(e,n)}));const It=["continue","continuePrimaryKey","advance"],J={},j=new WeakMap,X=new WeakMap,bt={get(t,e){if(!It.includes(e))return t[e];let n=J[e];return n||(n=J[e]=function(...o){j.set(this,X.get(this)[e](...o))}),n}};async function*St(...t){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...t)),!e)return;e=e;const n=new Proxy(e,bt);for(X.set(n,e),A.set(n,k(e));e;)yield n,e=await(j.get(n)||e.continue()),j.delete(n)}function Y(t,e){return e===Symbol.asyncIterator&&M(t,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&M(t,[IDBIndex,IDBObjectStore])}z(t=>({...t,get(e,n,o){return Y(e,n)?St:t.get(e,n,o)},has(e,n){return Y(e,n)||t.has(e,n)}}));const vt=[{name:"Read Later",emoji:"üìñ"},{name:"Reference",emoji:"üìå"},{name:"Share",emoji:"üîó"},{name:"Project",emoji:"üìÅ"}],Z=["#818cf8","#34d399","#fbbf24","#f87171","#38bdf8","#a78bfa","#fb7185","#2dd4bf"],U={"github.com":"Development","gitlab.com":"Development","stackoverflow.com":"Development","dev.to":"Development","npmjs.com":"Development","docs.python.org":"Development","developer.mozilla.org":"Development","medium.com":"Articles","substack.com":"Articles","hashnode.com":"Articles","blog.":"Articles","youtube.com":"Videos","vimeo.com":"Videos","twitch.tv":"Videos","twitter.com":"Social","x.com":"Social","linkedin.com":"Social","reddit.com":"Social","facebook.com":"Social","news.ycombinator.com":"Tech News","techcrunch.com":"Tech News","theverge.com":"Tech News","arstechnica.com":"Tech News","wired.com":"Tech News","arxiv.org":"Research","scholar.google.com":"Research","researchgate.net":"Research","nature.com":"Research","sciencedirect.com":"Research","figma.com":"Design","dribbble.com":"Design","behance.net":"Design","awwwards.com":"Design","openai.com":"AI","anthropic.com":"AI","huggingface.co":"AI"},B=3,G="resurface",tt=1,Tt=new Set(["the","a","an","and","or","but","in","on","at","to","for","of","with","by","from","is","are","was","were","be","been","being","have","has","had","do","does","did","will","would","could","should","may","might","must","shall","can","need","how","what","when","where","why","who","which","this","that","these","those","i","you","he","she","it","we","they","my","your","his","her","its","our","their","me","him","us","them","just","only","also","very","too","so","than","then","now","here","there","all","each","every","both","few","more","most","other","some","such","no","not","any","new","first","last","long","great","little","own","same","right","big","high","different","small","large","next","early","young","important","public","bad","good","best","well","way","use","using","used","get","getting","got","make","making","made","part","full","complete","guide","tutorial","introduction","intro","overview"]);let E;const At=new Uint8Array(16);function Dt(){if(!E&&(E=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!E))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return E(At)}const g=[];for(let t=0;t<256;++t)g.push((t+256).toString(16).slice(1));function Et(t,e=0){return g[t[e+0]]+g[t[e+1]]+g[t[e+2]]+g[t[e+3]]+"-"+g[t[e+4]]+g[t[e+5]]+"-"+g[t[e+6]]+g[t[e+7]]+"-"+g[t[e+8]]+g[t[e+9]]+"-"+g[t[e+10]]+g[t[e+11]]+g[t[e+12]]+g[t[e+13]]+g[t[e+14]]+g[t[e+15]]}const et={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function Rt(t,e,n){if(et.randomUUID&&!t)return et.randomUUID();t=t||{};const o=t.random||(t.rng||Dt)();return o[6]=o[6]&15|64,o[8]=o[8]&63|128,Et(o)}function p(){return Rt()}function f(){return Date.now()}function b(t){try{const{hostname:e}=new URL(t);return e.replace("www.","")}catch{return""}}function nt(t){return t.toLowerCase().replace(/[^a-z0-9\s]/g," ").split(/\s+/).filter(e=>e.length>2&&!Tt.has(e)&&!/^\d+$/.test(e)).slice(0,5)}function xt(t){return t.charAt(0).toUpperCase()+t.slice(1)}function $(t){const e=Math.floor((Date.now()-t)/1e3);if(e<60)return"Just now";const n=Math.floor(e/60);if(n<60)return`${n}m ago`;const o=Math.floor(n/60);if(o<24)return`${o}h ago`;const s=Math.floor(o/24);if(s<7)return`${s}d ago`;const i=Math.floor(s/7);if(i<4)return`${i}w ago`;const a=Math.floor(s/30);return a<12?`${a}mo ago`:`${Math.floor(s/365)}y ago`}function Ct(t,e,n){return[t.toLowerCase(),e.toLowerCase(),(n==null?void 0:n.toLowerCase())||""].join(" ").trim()}function ot(t,e){const n=t.filter(o=>!e.includes(o));return n.length===0?t[Math.floor(Math.random()*t.length)]:n[Math.floor(Math.random()*n.length)]}const st="tabmind";let y=null;async function u(){return console.log("Resurface Storage: ensureDb called, db exists:",!!y),y||(console.log("Resurface Storage: DB not initialized, calling initStorage..."),await V(),console.log("Resurface Storage: initStorage completed, db exists:",!!y)),y}async function V(){y||(await Lt(),y=await D(G,tt,{upgrade(t,e,n){if(console.log(`Resurface Storage: Upgrading DB from v${e} to v${n}`),!t.objectStoreNames.contains("savedItems")){const o=t.createObjectStore("savedItems",{keyPath:"id"});o.createIndex("by-url","url"),o.createIndex("by-savedAt","savedAt"),o.createIndex("by-searchText","searchText")}t.objectStoreNames.contains("topics")||t.createObjectStore("topics",{keyPath:"id"}).createIndex("by-name","name"),t.objectStoreNames.contains("intents")||t.createObjectStore("intents",{keyPath:"id"}).createIndex("by-name","name"),t.objectStoreNames.contains("settings")||t.createObjectStore("settings",{keyPath:"id"})}}),await Mt())}async function Lt(){try{if(!(await indexedDB.databases()).some(r=>r.name===st)){console.log("Resurface Storage: No old TabMind database found, skipping migration");return}console.log("Resurface Storage: Found old TabMind database, starting migration...");const n=await D(st,1);let o=!1;try{const r=await D(G,1);o=(await r.getAll("savedItems")).length>0,r.close()}catch{}if(o){console.log("Resurface Storage: New database already has data, skipping migration"),n.close();return}const s=await n.getAll("savedItems"),i=await n.getAll("topics"),a=await n.getAll("intents"),l=await n.get("settings","main");console.log(`Resurface Storage: Migrating ${s.length} items, ${i.length} topics, ${a.length} intents`),n.close();const d=await D(G,tt,{upgrade(r){if(!r.objectStoreNames.contains("savedItems")){const m=r.createObjectStore("savedItems",{keyPath:"id"});m.createIndex("by-url","url"),m.createIndex("by-savedAt","savedAt"),m.createIndex("by-searchText","searchText")}r.objectStoreNames.contains("topics")||r.createObjectStore("topics",{keyPath:"id"}).createIndex("by-name","name"),r.objectStoreNames.contains("intents")||r.createObjectStore("intents",{keyPath:"id"}).createIndex("by-name","name"),r.objectStoreNames.contains("settings")||r.createObjectStore("settings",{keyPath:"id"})}}),c=d.transaction(["savedItems","topics","intents","settings"],"readwrite");for(const r of s)await c.objectStore("savedItems").put(r);for(const r of i)await c.objectStore("topics").put(r);for(const r of a)await c.objectStore("intents").put(r);l&&await c.objectStore("settings").put(l),await c.done,d.close(),console.log("Resurface Storage: Migration completed successfully!")}catch(t){console.error("Resurface Storage: Migration error (non-fatal):",t)}}const I=[{url:"https://gemini.google.com",title:"Gemini - AI Assistant by Google",searchKeywords:"gemini ai google assistant chatbot bard artificial intelligence"},{url:"https://mail.google.com",title:"Gmail - Email by Google",searchKeywords:"gmail email mail google inbox messages compose send receive"},{url:"https://drive.google.com",title:"Google Drive - Cloud Storage",searchKeywords:"drive google storage files documents backup cloud sync"},{url:"https://docs.google.com",title:"Google Docs - Document Editor",searchKeywords:"docs google documents word editor write text typing"},{url:"https://sheets.google.com",title:"Google Sheets - Spreadsheets",searchKeywords:"sheets google spreadsheet excel tables data cells rows columns"},{url:"https://slides.google.com",title:"Google Slides - Presentations",searchKeywords:"slides google presentations powerpoint ppt deck slideshow"},{url:"https://www.youtube.com",title:"YouTube - Video Platform",searchKeywords:"youtube videos watch streaming music tutorials entertainment"},{url:"https://maps.google.com",title:"Google Maps - Navigation & Places",searchKeywords:"maps google directions navigation places location street view"},{url:"https://calendar.google.com",title:"Google Calendar - Schedule & Events",searchKeywords:"calendar google schedule events meetings reminders appointments"},{url:"https://translate.google.com",title:"Google Translate - Language Translation",searchKeywords:"translate google translation language translator convert"},{url:"https://www.google.com/imghp",title:"Google Images - Image Search",searchKeywords:"images google pictures photos search visual find images"},{url:"https://news.google.com",title:"Google News - Latest Headlines",searchKeywords:"news google headlines articles current events breaking news stories"}];async function Mt(){const t=await u();if((await t.getAll("intents")).length===0)for(const s of vt)await t.add("intents",{id:p(),name:s.name,emoji:s.emoji,createdAt:f(),itemCount:0});if(await t.get("settings","main")||await t.add("settings",{id:"main",keyboardShortcut:"Cmd+Shift+S",autoSaveDelay:5e3,showResurfaceDropdown:!0,defaultIntentId:null}),(await t.getAll("savedItems")).length===0){console.log("Resurface Storage: Adding default saved pages for new user...");const s=await at(t,"Quick Access"),i=await at(t,"Google"),l=(await t.getAll("intents")).find(c=>c.name==="Quick Reference"),d=f();for(let c=0;c<I.length;c++){const r=I[c],m=new URL(r.url).hostname,Yt=[r.title,r.url,r.searchKeywords].join(" ").toLowerCase(),dt=d-c*1e3,Zt={id:p(),url:r.url,title:r.title,favicon:`https://www.google.com/s2/favicons?domain=${m}&sz=64`,faviconType:"url",savedAt:dt,lastAccessedAt:dt,referrerQuery:null,referrerUrl:null,siblingTabUrls:[],topicIds:[s.id,i.id],intentIds:l?[l.id]:[],searchText:Yt};await t.add("savedItems",Zt)}s.itemCount=I.length,i.itemCount=I.length,await t.put("topics",s),await t.put("topics",i),l&&(l.itemCount=I.length,await t.put("intents",l)),console.log(`Resurface Storage: Added ${I.length} default saved pages`)}}async function at(t,e){const n=await t.getFromIndex("topics","by-name",e);if(n)return n;const s=(await t.getAll("topics")).map(a=>a.color),i={id:p(),name:e,color:ot(Z,s),isAutoGenerated:!1,createdAt:f(),itemCount:0};return await t.add("topics",i),i}async function Ot(t){console.log("Resurface Storage: saveItem called with:",t.url);try{const e=await u();console.log("Resurface Storage: Got database reference"),console.log("Resurface Storage: Checking for existing item with URL:",t.url);const n=await e.getFromIndex("savedItems","by-url",t.url);if(console.log("Resurface Storage: Existing item found:",!!n),n){console.log("Resurface Storage: Updating existing item");const o={...n,...t,id:n.id,savedAt:n.savedAt,lastAccessedAt:f()};return await e.put("savedItems",o),console.log("Resurface Storage: Item updated successfully"),o}return console.log("Resurface Storage: Adding new item..."),await e.add("savedItems",t),console.log("Resurface Storage: Item added to database"),console.log("Resurface Storage: Updating topic counts for:",t.topicIds),await C(t.topicIds,1),console.log("Resurface Storage: Updating intent counts for:",t.intentIds),await L(t.intentIds,1),console.log("Resurface Storage: saveItem completed successfully"),t}catch(e){throw console.error("Resurface Storage: Error in saveItem:",e),e}}async function Nt(t){return(await u()).getFromIndex("savedItems","by-url",t)}async function it(){return(await(await u()).getAll("savedItems")).sort((n,o)=>o.savedAt-n.savedAt)}async function R(t,e=10){const n=await u(),o=t.toLowerCase().trim();if(!o)return[];const s=await n.getAll("savedItems"),i=o.split(/\s+/);return s.filter(a=>i.some(l=>a.searchText.includes(l))).sort((a,l)=>{const d=i.filter(r=>a.searchText.includes(r)).length,c=i.filter(r=>l.searchText.includes(r)).length;return c!==d?c-d:l.savedAt-a.savedAt}).slice(0,e)}async function _t(t){return(await(await u()).getAll("savedItems")).filter(o=>o.topicIds.includes(t)).sort((o,s)=>s.savedAt-o.savedAt)}async function kt(t){return(await(await u()).getAll("savedItems")).filter(o=>o.intentIds.includes(t)).sort((o,s)=>s.savedAt-o.savedAt)}async function W(t,e){const n=await u(),o=await n.get("savedItems",t);if(!o)return null;const s=o.topicIds,i=o.intentIds,a={...o,...e,lastAccessedAt:f()};if(await n.put("savedItems",a),e.topicIds){const l=s.filter(c=>!e.topicIds.includes(c)),d=e.topicIds.filter(c=>!s.includes(c));await C(l,-1),await C(d,1)}if(e.intentIds){const l=i.filter(c=>!e.intentIds.includes(c)),d=e.intentIds.filter(c=>!i.includes(c));await L(l,-1),await L(d,1)}return a}async function Pt(t){const e=await u(),n=await e.get("savedItems",t);return n?(await e.delete("savedItems",t),await C(n.topicIds,-1),await L(n.intentIds,-1),!0):!1}async function S(){return(await(await u()).getAll("topics")).sort((n,o)=>o.itemCount-n.itemCount)}async function x(t,e=!1){const n=await u(),o=t.trim(),s=await n.getFromIndex("topics","by-name",o);if(s)return s;const a=(await n.getAll("topics")).map(d=>d.color),l={id:p(),name:o,color:ot(Z,a),isAutoGenerated:e,createdAt:f(),itemCount:0};return await n.add("topics",l),l}async function jt(t){return x(t,!1)}async function C(t,e){const n=await u();for(const o of t){const s=await n.get("topics",o);s&&(s.itemCount=Math.max(0,s.itemCount+e),await n.put("topics",s))}}async function Ut(t){const e=await u();if(!await e.get("topics",t))return!1;const o=await _t(t);for(const s of o)await W(s.id,{topicIds:s.topicIds.filter(i=>i!==t)});return await e.delete("topics",t),!0}async function Bt(t,e){const n=await u(),o=await n.get("topics",t);return o?(o.name=e.trim(),await n.put("topics",o),o):null}async function v(){return(await(await u()).getAll("intents")).sort((n,o)=>o.itemCount-n.itemCount)}async function Gt(t,e){const n=await u(),o=t.trim(),i=(await n.getAll("intents")).find(l=>l.name.toLowerCase()===o.toLowerCase());if(i)return i;const a={id:p(),name:o,emoji:e,createdAt:f(),itemCount:0};return await n.add("intents",a),a}async function L(t,e){const n=await u();for(const o of t){const s=await n.get("intents",o);s&&(s.itemCount=Math.max(0,s.itemCount+e),await n.put("intents",s))}}async function $t(t){const e=await u();if(!await e.get("intents",t))return!1;const o=await kt(t);for(const s of o)await W(s.id,{intentIds:s.intentIds.filter(i=>i!==t)});return await e.delete("intents",t),!0}async function Vt(t,e,n){const o=await u(),s=await o.get("intents",t);return s?(s.name=e.trim(),s.emoji=n,await o.put("intents",s),s):null}async function T(){return await(await u()).get("settings","main")}async function rt(t){const e=await u(),o={...await T(),...t};return await e.put("settings",o),o}async function Wt(){const t=await u(),e=await t.getAll("savedItems"),n=await t.getAll("topics"),o=await t.getAll("intents"),s=await t.get("settings","main");return{version:"1.0.0",exportedAt:f(),items:e,topics:n,intents:o,settings:s||void 0}}async function Kt(t,e){const n=await u();try{if(console.log(`Resurface Storage: Importing data in ${e} mode`),console.log(`Resurface Storage: Data contains ${t.items.length} items, ${t.topics.length} topics, ${t.intents.length} intents`),!t.items||!t.topics||!t.intents)throw new Error("Invalid backup format: missing required fields");let o=0,s=0,i=0;if(e==="replace"){const a=n.transaction(["savedItems","topics","intents"],"readwrite");await a.objectStore("savedItems").clear(),await a.objectStore("topics").clear(),await a.objectStore("intents").clear(),await a.done,console.log("Resurface Storage: Cleared existing data for replace mode")}for(const a of t.topics)try{e==="merge"?await n.getFromIndex("topics","by-name",a.name)||(await n.add("topics",a),s++):(await n.put("topics",a),s++)}catch(l){console.warn("Resurface Storage: Error importing topic:",a.name,l)}for(const a of t.intents)try{e==="merge"?await n.getFromIndex("intents","by-name",a.name)||(await n.add("intents",a),i++):(await n.put("intents",a),i++)}catch(l){console.warn("Resurface Storage: Error importing intent:",a.name,l)}for(const a of t.items)try{e==="merge"?await n.getFromIndex("savedItems","by-url",a.url)||(await n.add("savedItems",a),o++):(await n.put("savedItems",a),o++)}catch(l){console.warn("Resurface Storage: Error importing item:",a.url,l)}return t.settings&&e==="replace"&&await n.put("settings",t.settings),console.log(`Resurface Storage: Import completed - ${o} items, ${s} topics, ${i} intents`),{success:!0,imported:{items:o,topics:s,intents:i}}}catch(o){throw console.error("Resurface Storage: Import error:",o),o}}async function Ft(t){const e=[],n=new Set,o=await Ht(t.url);o&&!n.has(o.name.toLowerCase())&&(e.push(o),n.add(o.name.toLowerCase()));const s=await S(),i=nt(t.title),a=t.referrerQuery?nt(t.referrerQuery):[],l=[...new Set([...a,...i])];for(const d of l){if(e.length>=B)break;const c=qt(d,s);c&&!n.has(c.name.toLowerCase())&&(e.push(c),n.add(c.name.toLowerCase()))}if(e.length<B&&l.length>0)for(const d of l){if(e.length>=B)break;const c=xt(d);if(!n.has(c.toLowerCase())&&d.length>=3&&zt(d)){const r=await x(c,!0);e.push(r),n.add(c.toLowerCase())}}return e}async function Ht(t){const e=b(t);if(U[e])return x(U[e],!0);for(const[n,o]of Object.entries(U))if(n.endsWith(".")&&e.includes(n))return x(o,!0);return null}function qt(t,e){const n=t.toLowerCase(),o=e.find(i=>i.name.toLowerCase()===n);if(o)return o;const s=e.find(i=>{const a=i.name.toLowerCase();return a.includes(n)||n.includes(a)});return s||null}function zt(t){return!(t.length<3||new Set(["app","web","site","page","post","blog","news","article","home","about","contact","help","faq","terms","privacy","login","signup","register","account","profile","settings","search","results","list","view","edit","create","delete","file","files","folder","document","image","video","audio","free","pro","premium","trial","demo","beta","alpha","online","digital","virtual","mobile","desktop","cloud"]).has(t.toLowerCase())||/^\d+$/.test(t))}function Qt(t,e){return{type:t,payload:e}}async function w(t,e,n){return chrome.tabs.sendMessage(t,Qt(e,n))}chrome.runtime.onInstalled.addListener(async()=>{await V(),await K(),console.log("Resurface installed and initialized")}),chrome.runtime.onStartup.addListener(async()=>{await V(),await K(),console.log("Resurface started")});async function K(){const e=(await chrome.commands.getAll()).find(n=>n.name==="save-tab");e!=null&&e.shortcut&&await rt({keyboardShortcut:e.shortcut})}chrome.commands.onCommand.addListener(async t=>{t==="save-tab"?await F():t==="resurface"&&await Jt()}),chrome.omnibox.onInputChanged.addListener(async(t,e)=>{if(t.length<2){e([]);return}const o=(await R(t,6)).map(s=>({content:s.url,description:`<match>${ct(s.title)}</match> <dim>- ${ct(b(s.url))}</dim>`}));e(o)}),chrome.omnibox.onInputEntered.addListener(async(t,e)=>{let n;switch(t.startsWith("http://")||t.startsWith("https://")?n=t:n=chrome.runtime.getURL(`src/dashboard/index.html?search=${encodeURIComponent(t)}`),e){case"currentTab":chrome.tabs.update({url:n});break;case"newForegroundTab":chrome.tabs.create({url:n});break;case"newBackgroundTab":chrome.tabs.create({url:n,active:!1});break}});function ct(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}chrome.action.onClicked.addListener(async t=>{t.id&&await F()});async function lt(t){try{await chrome.tabs.sendMessage(t,{type:"PING"})}catch{console.log("Content script not found, injecting..."),await chrome.scripting.executeScript({target:{tabId:t},files:["src/content/index.js"]}),await chrome.scripting.insertCSS({target:{tabId:t},files:["src/content/styles.css"]}),await new Promise(e=>setTimeout(e,100))}}async function Jt(){const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!(t!=null&&t.id)||!t.url){console.log("No active tab or URL");return}if(!t.url.startsWith("http://")&&!t.url.startsWith("https://")){chrome.tabs.create({url:chrome.runtime.getURL("src/dashboard/index.html")});return}try{await lt(t.id);const e=await it(),n=await S(),o=await v(),s=e.slice(0,20).map(i=>({id:i.id,title:i.title,url:i.url,favicon:i.favicon,faviconType:i.faviconType,domain:b(i.url),savedAt:$(i.savedAt),topics:n.filter(a=>i.topicIds.includes(a.id)),intents:o.filter(a=>i.intentIds.includes(a.id))}));await w(t.id,"SHOW_SEARCH_MODAL",{items:s})}catch(e){console.error("Error in resurface command:",e)}}async function F(){const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!(t!=null&&t.id)||!t.url){console.log("No active tab or URL");return}if(!t.url.startsWith("http://")&&!t.url.startsWith("https://")){console.log("Cannot save restricted URL:",t.url);return}try{await lt(t.id);const e=await Nt(t.url);if(e){await w(t.id,"SHOW_ALREADY_SAVED",{item:e});return}const n=await w(t.id,"EXTRACT_PAGE"),s=(await chrome.tabs.query({windowId:t.windowId})).filter(c=>{var r;return c.id!==t.id&&((r=c.url)==null?void 0:r.startsWith("http"))}).map(c=>c.url).slice(0,10),i=await Ft({url:n.url,title:n.title,referrerQuery:n.referrerQuery}),a=await v(),l=await T(),d={pageData:n,suggestedTopics:i,intents:a,siblingTabUrls:s,autoSaveDelay:l.autoSaveDelay};w(t.id,"SHOW_TOAST",d).catch(c=>{console.error("Error showing toast:",c)})}catch(e){console.error("Error in save command:",e)}}chrome.runtime.onMessage.addListener((t,e,n)=>{const o=Xt[t.type];return o?(o(t.payload,e).then(n).catch(s=>{console.error(`Error handling ${t.type}:`,s),n({error:s.message})}),!0):(console.warn("Unknown message type:",t.type),!1)});const Xt={async SAVE_ITEM(t){console.log("Resurface Background: ========== SAVE_ITEM RECEIVED =========="),console.log("Resurface Background: Payload:",JSON.stringify(t,null,2));try{const{pageData:e,toastResult:n,siblingTabUrls:o}=t;console.log("Resurface Background: Creating item object...");const s={id:p(),url:e.url,title:n.title,favicon:e.favicon,faviconType:e.faviconType,savedAt:f(),lastAccessedAt:f(),referrerQuery:e.referrerQuery,referrerUrl:e.referrerUrl,siblingTabUrls:o,topicIds:n.topicIds,intentIds:n.intentIds,searchText:Ct(n.title,e.url,e.referrerQuery)};console.log("Resurface Background: Item created:",JSON.stringify(s,null,2)),console.log("Resurface Background: Calling saveItem...");const i=await Ot(s);return console.log("Resurface Background: ========== ITEM SAVED SUCCESSFULLY =========="),console.log("Resurface Background: Saved item:",JSON.stringify(i,null,2)),i}catch(e){throw console.error("Resurface Background: ========== SAVE_ITEM ERROR =========="),console.error("Resurface Background: Error:",e),e}},async SEARCH_ITEMS(t){return R(t.query)},async GET_ALL_ITEMS(){return it()},async GET_ALL_TOPICS(){return S()},async GET_ALL_INTENTS(){return v()},async DELETE_ITEM(t){return Pt(t.id)},async UPDATE_ITEM(t){return W(t.id,t.updates)},async CREATE_TOPIC(t){return jt(t.name)},async CREATE_INTENT(t){return Gt(t.name,t.emoji)},async RENAME_TOPIC(t){return Bt(t.id,t.name)},async DELETE_TOPIC(t){return Ut(t.id)},async RENAME_INTENT(t){return Vt(t.id,t.name,t.emoji)},async DELETE_INTENT(t){return $t(t.id)},async URL_INPUT(t,e){var a;const{query:n}=t,o=(a=e.tab)==null?void 0:a.id;if(!o||!(await T()).showResurfaceDropdown)return;if(n.length<2){await w(o,"HIDE_DROPDOWN");return}const i=await R(n,5);if(i.length>0){const l=await S(),d=await v(),c=i.map(r=>({id:r.id,title:r.title,url:r.url,favicon:r.favicon,faviconType:r.faviconType,domain:b(r.url),savedAt:$(r.savedAt),topics:l.filter(m=>r.topicIds.includes(m.id)),intents:d.filter(m=>r.intentIds.includes(m.id))}));await w(o,"SHOW_DROPDOWN",{items:c})}else await w(o,"HIDE_DROPDOWN")},async TRIGGER_SAVE(){await F()},async GET_SETTINGS(){return await K(),T()},async UPDATE_SETTINGS(t){return rt(t)},async EXPORT_DATA(){return Wt()},async IMPORT_DATA(t){return Kt(t.data,t.mode)}};chrome.tabs.onUpdated.addListener(async(t,e,n)=>{if(e.status==="complete"&&n.url){if(!(await T()).showResurfaceDropdown)return;const s=n.url.match(/google\.[a-z.]+\/search\?.*q=([^&]+)/);if(s){const i=decodeURIComponent(s[1].replace(/\+/g," ")),a=await R(i,5);if(a.length>0)try{const l=await S(),d=await v(),c=a.map(r=>({id:r.id,title:r.title,url:r.url,favicon:r.favicon,faviconType:r.faviconType,domain:b(r.url),savedAt:$(r.savedAt),topics:l.filter(m=>r.topicIds.includes(m.id)),intents:d.filter(m=>r.intentIds.includes(m.id))}));await w(t,"SHOW_GOOGLE_OVERLAY",{items:c,query:i})}catch{}}}})})();
