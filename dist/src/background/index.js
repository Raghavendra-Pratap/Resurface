(function(){"use strict";const k=(e,t)=>t.some(s=>e instanceof s);let Q,H;function de(){return Q||(Q=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function me(){return H||(H=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const M=new WeakMap,O=new WeakMap,C=new WeakMap;function ge(e){const t=new Promise((s,o)=>{const n=()=>{e.removeEventListener("success",i),e.removeEventListener("error",a)},i=()=>{s(w(e.result)),n()},a=()=>{o(e.error),n()};e.addEventListener("success",i),e.addEventListener("error",a)});return C.set(t,e),t}function fe(e){if(M.has(e))return;const t=new Promise((s,o)=>{const n=()=>{e.removeEventListener("complete",i),e.removeEventListener("error",a),e.removeEventListener("abort",a)},i=()=>{s(),n()},a=()=>{o(e.error||new DOMException("AbortError","AbortError")),n()};e.addEventListener("complete",i),e.addEventListener("error",a),e.addEventListener("abort",a)});M.set(e,t)}let N={get(e,t,s){if(e instanceof IDBTransaction){if(t==="done")return M.get(e);if(t==="store")return s.objectStoreNames[1]?void 0:s.objectStore(s.objectStoreNames[0])}return w(e[t])},set(e,t,s){return e[t]=s,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function z(e){N=e(N)}function he(e){return me().includes(e)?function(...t){return e.apply(_(this),t),w(this.request)}:function(...t){return w(e.apply(_(this),t))}}function we(e){return typeof e=="function"?he(e):(e instanceof IDBTransaction&&fe(e),k(e,de())?new Proxy(e,N):e)}function w(e){if(e instanceof IDBRequest)return ge(e);if(O.has(e))return O.get(e);const t=we(e);return t!==e&&(O.set(e,t),C.set(t,e)),t}const _=e=>C.get(e);function A(e,t,{blocked:s,upgrade:o,blocking:n,terminated:i}={}){const a=indexedDB.open(e,t),l=w(a);return o&&a.addEventListener("upgradeneeded",u=>{o(w(a.result),u.oldVersion,u.newVersion,w(a.transaction),u)}),s&&a.addEventListener("blocked",u=>s(u.oldVersion,u.newVersion,u)),l.then(u=>{i&&u.addEventListener("close",()=>i()),n&&u.addEventListener("versionchange",c=>n(c.oldVersion,c.newVersion,c))}).catch(()=>{}),l}const pe=["get","getKey","getAll","getAllKeys","count"],ye=["put","add","delete","clear"],P=new Map;function Y(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(P.get(t))return P.get(t);const s=t.replace(/FromIndex$/,""),o=t!==s,n=ye.includes(s);if(!(s in(o?IDBIndex:IDBObjectStore).prototype)||!(n||pe.includes(s)))return;const i=async function(a,...l){const u=this.transaction(a,n?"readwrite":"readonly");let c=u.store;return o&&(c=c.index(l.shift())),(await Promise.all([c[s](...l),n&&u.done]))[0]};return P.set(t,i),i}z(e=>({...e,get:(t,s,o)=>Y(t,s)||e.get(t,s,o),has:(t,s)=>!!Y(t,s)||e.has(t,s)}));const be=["continue","continuePrimaryKey","advance"],J={},U=new WeakMap,X=new WeakMap,Ie={get(e,t){if(!be.includes(t))return e[t];let s=J[t];return s||(s=J[t]=function(...o){U.set(this,X.get(this)[t](...o))}),s}};async function*Se(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;t=t;const s=new Proxy(t,Ie);for(X.set(s,t),C.set(s,_(t));t;)yield s,t=await(U.get(s)||t.continue()),U.delete(s)}function Z(e,t){return t===Symbol.asyncIterator&&k(e,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&k(e,[IDBIndex,IDBObjectStore])}z(e=>({...e,get(t,s,o){return Z(t,s)?Se:e.get(t,s,o)},has(t,s){return Z(t,s)||e.has(t,s)}}));const ve=[{name:"Read Later",emoji:"üìñ"},{name:"Reference",emoji:"üìå"},{name:"Share",emoji:"üîó"},{name:"Project",emoji:"üìÅ"}],ee=["#818cf8","#34d399","#fbbf24","#f87171","#38bdf8","#a78bfa","#fb7185","#2dd4bf"],j={"github.com":"Development","gitlab.com":"Development","stackoverflow.com":"Development","dev.to":"Development","npmjs.com":"Development","docs.python.org":"Development","developer.mozilla.org":"Development","medium.com":"Articles","substack.com":"Articles","hashnode.com":"Articles","blog.":"Articles","youtube.com":"Videos","vimeo.com":"Videos","twitch.tv":"Videos","twitter.com":"Social","x.com":"Social","linkedin.com":"Social","reddit.com":"Social","facebook.com":"Social","news.ycombinator.com":"Tech News","techcrunch.com":"Tech News","theverge.com":"Tech News","arstechnica.com":"Tech News","wired.com":"Tech News","arxiv.org":"Research","scholar.google.com":"Research","researchgate.net":"Research","nature.com":"Research","sciencedirect.com":"Research","figma.com":"Design","dribbble.com":"Design","behance.net":"Design","awwwards.com":"Design","openai.com":"AI","anthropic.com":"AI","huggingface.co":"AI"},B=3,G="resurface",te=1,Te=new Set(["the","a","an","and","or","but","in","on","at","to","for","of","with","by","from","is","are","was","were","be","been","being","have","has","had","do","does","did","will","would","could","should","may","might","must","shall","can","need","how","what","when","where","why","who","which","this","that","these","those","i","you","he","she","it","we","they","my","your","his","her","its","our","their","me","him","us","them","just","only","also","very","too","so","than","then","now","here","there","all","each","every","both","few","more","most","other","some","such","no","not","any","new","first","last","long","great","little","own","same","right","big","high","different","small","large","next","early","young","important","public","bad","good","best","well","way","use","using","used","get","getting","got","make","making","made","part","full","complete","guide","tutorial","introduction","intro","overview"]);let D;const Ce=new Uint8Array(16);function Ae(){if(!D&&(D=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!D))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return D(Ce)}const m=[];for(let e=0;e<256;++e)m.push((e+256).toString(16).slice(1));function De(e,t=0){return m[e[t+0]]+m[e[t+1]]+m[e[t+2]]+m[e[t+3]]+"-"+m[e[t+4]]+m[e[t+5]]+"-"+m[e[t+6]]+m[e[t+7]]+"-"+m[e[t+8]]+m[e[t+9]]+"-"+m[e[t+10]]+m[e[t+11]]+m[e[t+12]]+m[e[t+13]]+m[e[t+14]]+m[e[t+15]]}const se={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function Ee(e,t,s){if(se.randomUUID&&!e)return se.randomUUID();e=e||{};const o=e.random||(e.rng||Ae)();return o[6]=o[6]&15|64,o[8]=o[8]&63|128,De(o)}function p(){return Ee()}function f(){return Date.now()}function I(e){try{const{hostname:t}=new URL(e);return t.replace("www.","")}catch{return""}}function oe(e){return e.toLowerCase().replace(/[^a-z0-9\s]/g," ").split(/\s+/).filter(t=>t.length>2&&!Te.has(t)&&!/^\d+$/.test(t)).slice(0,5)}function Re(e){return e.charAt(0).toUpperCase()+e.slice(1)}function $(e){const t=Math.floor((Date.now()-e)/1e3);if(t<60)return"Just now";const s=Math.floor(t/60);if(s<60)return`${s}m ago`;const o=Math.floor(s/60);if(o<24)return`${o}h ago`;const n=Math.floor(o/24);if(n<7)return`${n}d ago`;const i=Math.floor(n/7);if(i<4)return`${i}w ago`;const a=Math.floor(n/30);return a<12?`${a}mo ago`:`${Math.floor(n/365)}y ago`}function xe(e,t,s){return[e.toLowerCase(),t.toLowerCase(),(s==null?void 0:s.toLowerCase())||""].join(" ").trim()}function ne(e,t){const s=e.filter(o=>!t.includes(o));return s.length===0?e[Math.floor(Math.random()*e.length)]:s[Math.floor(Math.random()*s.length)]}const ae="tabmind";let y=null;async function d(){return console.log("Resurface Storage: ensureDb called, db exists:",!!y),y||(console.log("Resurface Storage: DB not initialized, calling initStorage..."),await V(),console.log("Resurface Storage: initStorage completed, db exists:",!!y)),y}async function V(){y||(await Le(),y=await A(G,te,{upgrade(e,t,s){if(console.log(`Resurface Storage: Upgrading DB from v${t} to v${s}`),!e.objectStoreNames.contains("savedItems")){const o=e.createObjectStore("savedItems",{keyPath:"id"});o.createIndex("by-url","url"),o.createIndex("by-savedAt","savedAt"),o.createIndex("by-searchText","searchText")}e.objectStoreNames.contains("topics")||e.createObjectStore("topics",{keyPath:"id"}).createIndex("by-name","name"),e.objectStoreNames.contains("intents")||e.createObjectStore("intents",{keyPath:"id"}).createIndex("by-name","name"),e.objectStoreNames.contains("settings")||e.createObjectStore("settings",{keyPath:"id"})}}),await ke())}async function Le(){try{if(!(await indexedDB.databases()).some(r=>r.name===ae)){console.log("Resurface Storage: No old TabMind database found, skipping migration");return}console.log("Resurface Storage: Found old TabMind database, starting migration...");const s=await A(ae,1);let o=!1;try{const r=await A(G,1);o=(await r.getAll("savedItems")).length>0,r.close()}catch{}if(o){console.log("Resurface Storage: New database already has data, skipping migration"),s.close();return}const n=await s.getAll("savedItems"),i=await s.getAll("topics"),a=await s.getAll("intents"),l=await s.get("settings","main");console.log(`Resurface Storage: Migrating ${n.length} items, ${i.length} topics, ${a.length} intents`),s.close();const u=await A(G,te,{upgrade(r){if(!r.objectStoreNames.contains("savedItems")){const g=r.createObjectStore("savedItems",{keyPath:"id"});g.createIndex("by-url","url"),g.createIndex("by-savedAt","savedAt"),g.createIndex("by-searchText","searchText")}r.objectStoreNames.contains("topics")||r.createObjectStore("topics",{keyPath:"id"}).createIndex("by-name","name"),r.objectStoreNames.contains("intents")||r.createObjectStore("intents",{keyPath:"id"}).createIndex("by-name","name"),r.objectStoreNames.contains("settings")||r.createObjectStore("settings",{keyPath:"id"})}}),c=u.transaction(["savedItems","topics","intents","settings"],"readwrite");for(const r of n)await c.objectStore("savedItems").put(r);for(const r of i)await c.objectStore("topics").put(r);for(const r of a)await c.objectStore("intents").put(r);l&&await c.objectStore("settings").put(l),await c.done,u.close(),console.log("Resurface Storage: Migration completed successfully!")}catch(e){console.error("Resurface Storage: Migration error (non-fatal):",e)}}const b=[{url:"https://gemini.google.com",title:"Gemini - AI Assistant by Google",searchKeywords:"gemini ai google assistant chatbot bard artificial intelligence"},{url:"https://mail.google.com",title:"Gmail - Email by Google",searchKeywords:"gmail email mail google inbox messages compose send receive"},{url:"https://drive.google.com",title:"Google Drive - Cloud Storage",searchKeywords:"drive google storage files documents backup cloud sync"},{url:"https://docs.google.com",title:"Google Docs - Document Editor",searchKeywords:"docs google documents word editor write text typing"},{url:"https://sheets.google.com",title:"Google Sheets - Spreadsheets",searchKeywords:"sheets google spreadsheet excel tables data cells rows columns"},{url:"https://slides.google.com",title:"Google Slides - Presentations",searchKeywords:"slides google presentations powerpoint ppt deck slideshow"},{url:"https://www.youtube.com",title:"YouTube - Video Platform",searchKeywords:"youtube videos watch streaming music tutorials entertainment"},{url:"https://maps.google.com",title:"Google Maps - Navigation & Places",searchKeywords:"maps google directions navigation places location street view"},{url:"https://calendar.google.com",title:"Google Calendar - Schedule & Events",searchKeywords:"calendar google schedule events meetings reminders appointments"},{url:"https://translate.google.com",title:"Google Translate - Language Translation",searchKeywords:"translate google translation language translator convert"},{url:"https://www.google.com/imghp",title:"Google Images - Image Search",searchKeywords:"images google pictures photos search visual find images"},{url:"https://news.google.com",title:"Google News - Latest Headlines",searchKeywords:"news google headlines articles current events breaking news stories"}];async function ke(){const e=await d();if((await e.getAll("intents")).length===0)for(const n of ve)await e.add("intents",{id:p(),name:n.name,emoji:n.emoji,createdAt:f(),itemCount:0});const s=await e.get("settings","main");if(s){if(!s.showQuickShortcuts!==void 0&&!s.quickShortcuts){const n=[{id:"gemini",url:"https://gemini.google.com",title:"Gemini",enabled:!0,isCustom:!1},{id:"gmail",url:"https://mail.google.com",title:"Gmail",enabled:!0,isCustom:!1},{id:"drive",url:"https://drive.google.com",title:"Drive",enabled:!0,isCustom:!1},{id:"docs",url:"https://docs.google.com",title:"Docs",enabled:!0,isCustom:!1},{id:"sheets",url:"https://sheets.google.com",title:"Sheets",enabled:!0,isCustom:!1},{id:"slides",url:"https://slides.google.com",title:"Slides",enabled:!0,isCustom:!1},{id:"youtube",url:"https://www.youtube.com",title:"YouTube",enabled:!0,isCustom:!1},{id:"maps",url:"https://maps.google.com",title:"Maps",enabled:!0,isCustom:!1},{id:"calendar",url:"https://calendar.google.com",title:"Calendar",enabled:!0,isCustom:!1},{id:"translate",url:"https://translate.google.com",title:"Translate",enabled:!0,isCustom:!1},{id:"images",url:"https://www.google.com/imghp",title:"Images",enabled:!0,isCustom:!1},{id:"news",url:"https://news.google.com",title:"News",enabled:!0,isCustom:!1}];s.showQuickShortcuts=s.showQuickShortcuts??!0,s.quickShortcuts=s.quickShortcuts??n,await e.put("settings",s)}}else{const n=[{id:"gemini",url:"https://gemini.google.com",title:"Gemini",enabled:!0,isCustom:!1},{id:"gmail",url:"https://mail.google.com",title:"Gmail",enabled:!0,isCustom:!1},{id:"drive",url:"https://drive.google.com",title:"Drive",enabled:!0,isCustom:!1},{id:"docs",url:"https://docs.google.com",title:"Docs",enabled:!0,isCustom:!1},{id:"sheets",url:"https://sheets.google.com",title:"Sheets",enabled:!0,isCustom:!1},{id:"slides",url:"https://slides.google.com",title:"Slides",enabled:!0,isCustom:!1},{id:"youtube",url:"https://www.youtube.com",title:"YouTube",enabled:!0,isCustom:!1},{id:"maps",url:"https://maps.google.com",title:"Maps",enabled:!0,isCustom:!1},{id:"calendar",url:"https://calendar.google.com",title:"Calendar",enabled:!0,isCustom:!1},{id:"translate",url:"https://translate.google.com",title:"Translate",enabled:!0,isCustom:!1},{id:"images",url:"https://www.google.com/imghp",title:"Images",enabled:!0,isCustom:!1},{id:"news",url:"https://news.google.com",title:"News",enabled:!0,isCustom:!1}];await e.add("settings",{id:"main",keyboardShortcut:"Cmd+Shift+S",autoSaveDelay:5e3,showResurfaceDropdown:!0,defaultIntentId:null,showQuickShortcuts:!0,quickShortcuts:n})}if((await e.getAll("savedItems")).length===0){console.log("Resurface Storage: Adding default saved pages for new user...");const n=await ie(e,"Quick Access"),i=await ie(e,"Google"),l=(await e.getAll("intents")).find(c=>c.name==="Quick Reference"),u=f();for(let c=0;c<b.length;c++){const r=b[c],g=new URL(r.url).hostname,Xe=[r.title,r.url,r.searchKeywords].join(" ").toLowerCase(),ue=u-c*1e3,Ze={id:p(),url:r.url,title:r.title,favicon:`https://www.google.com/s2/favicons?domain=${g}&sz=64`,faviconType:"url",savedAt:ue,lastAccessedAt:ue,referrerQuery:null,referrerUrl:null,siblingTabUrls:[],topicIds:[n.id,i.id],intentIds:l?[l.id]:[],searchText:Xe};await e.add("savedItems",Ze)}n.itemCount=b.length,i.itemCount=b.length,await e.put("topics",n),await e.put("topics",i),l&&(l.itemCount=b.length,await e.put("intents",l)),console.log(`Resurface Storage: Added ${b.length} default saved pages`)}}async function ie(e,t){const s=await e.getFromIndex("topics","by-name",t);if(s)return s;const n=(await e.getAll("topics")).map(a=>a.color),i={id:p(),name:t,color:ne(ee,n),isAutoGenerated:!1,createdAt:f(),itemCount:0};return await e.add("topics",i),i}async function Me(e){console.log("Resurface Storage: saveItem called with:",e.url);try{const t=await d();console.log("Resurface Storage: Got database reference"),console.log("Resurface Storage: Checking for existing item with URL:",e.url);const s=await t.getFromIndex("savedItems","by-url",e.url);if(console.log("Resurface Storage: Existing item found:",!!s),s){console.log("Resurface Storage: Updating existing item");const o={...s,...e,id:s.id,savedAt:s.savedAt,lastAccessedAt:f()};return await t.put("savedItems",o),console.log("Resurface Storage: Item updated successfully"),o}return console.log("Resurface Storage: Adding new item..."),await t.add("savedItems",e),console.log("Resurface Storage: Item added to database"),console.log("Resurface Storage: Updating topic counts for:",e.topicIds),await x(e.topicIds,1),console.log("Resurface Storage: Updating intent counts for:",e.intentIds),await L(e.intentIds,1),console.log("Resurface Storage: saveItem completed successfully"),e}catch(t){throw console.error("Resurface Storage: Error in saveItem:",t),t}}async function Oe(e){return(await d()).getFromIndex("savedItems","by-url",e)}async function re(){return(await(await d()).getAll("savedItems")).sort((s,o)=>o.savedAt-s.savedAt)}async function E(e,t=10){const s=await d(),o=e.toLowerCase().trim();if(!o)return[];const n=await s.getAll("savedItems"),i=o.split(/\s+/);return n.filter(a=>i.some(l=>a.searchText.includes(l))).sort((a,l)=>{const u=i.filter(r=>a.searchText.includes(r)).length,c=i.filter(r=>l.searchText.includes(r)).length;return c!==u?c-u:l.savedAt-a.savedAt}).slice(0,t)}async function Ne(e){return(await(await d()).getAll("savedItems")).filter(o=>o.topicIds.includes(e)).sort((o,n)=>n.savedAt-o.savedAt)}async function _e(e){return(await(await d()).getAll("savedItems")).filter(o=>o.intentIds.includes(e)).sort((o,n)=>n.savedAt-o.savedAt)}async function W(e,t){const s=await d(),o=await s.get("savedItems",e);if(!o)return null;const n=o.topicIds,i=o.intentIds,a={...o,...t,lastAccessedAt:f()};if(await s.put("savedItems",a),t.topicIds){const l=n.filter(c=>!t.topicIds.includes(c)),u=t.topicIds.filter(c=>!n.includes(c));await x(l,-1),await x(u,1)}if(t.intentIds){const l=i.filter(c=>!t.intentIds.includes(c)),u=t.intentIds.filter(c=>!i.includes(c));await L(l,-1),await L(u,1)}return a}async function Pe(e){const t=await d(),s=await t.get("savedItems",e);return s?(await t.delete("savedItems",e),await x(s.topicIds,-1),await L(s.intentIds,-1),!0):!1}async function S(){return(await(await d()).getAll("topics")).sort((s,o)=>o.itemCount-s.itemCount)}async function R(e,t=!1){const s=await d(),o=e.trim(),n=await s.getFromIndex("topics","by-name",o);if(n)return n;const a=(await s.getAll("topics")).map(u=>u.color),l={id:p(),name:o,color:ne(ee,a),isAutoGenerated:t,createdAt:f(),itemCount:0};return await s.add("topics",l),l}async function Ue(e){return R(e,!1)}async function x(e,t){const s=await d();for(const o of e){const n=await s.get("topics",o);n&&(n.itemCount=Math.max(0,n.itemCount+t),await s.put("topics",n))}}async function je(e){const t=await d();if(!await t.get("topics",e))return!1;const o=await Ne(e);for(const n of o)await W(n.id,{topicIds:n.topicIds.filter(i=>i!==e)});return await t.delete("topics",e),!0}async function Be(e,t){const s=await d(),o=await s.get("topics",e);return o?(o.name=t.trim(),await s.put("topics",o),o):null}async function v(){return(await(await d()).getAll("intents")).sort((s,o)=>o.itemCount-s.itemCount)}async function Ge(e,t){const s=await d(),o=e.trim(),i=(await s.getAll("intents")).find(l=>l.name.toLowerCase()===o.toLowerCase());if(i)return i;const a={id:p(),name:o,emoji:t,createdAt:f(),itemCount:0};return await s.add("intents",a),a}async function L(e,t){const s=await d();for(const o of e){const n=await s.get("intents",o);n&&(n.itemCount=Math.max(0,n.itemCount+t),await s.put("intents",n))}}async function $e(e){const t=await d();if(!await t.get("intents",e))return!1;const o=await _e(e);for(const n of o)await W(n.id,{intentIds:n.intentIds.filter(i=>i!==e)});return await t.delete("intents",e),!0}async function Ve(e,t,s){const o=await d(),n=await o.get("intents",e);return n?(n.name=t.trim(),n.emoji=s,await o.put("intents",n),n):null}async function T(){const e=await d();let t=await e.get("settings","main");if(t&&(!t.quickShortcuts||t.showQuickShortcuts===void 0)){const s=[{id:"gemini",url:"https://gemini.google.com",title:"Gemini",enabled:!0,isCustom:!1},{id:"gmail",url:"https://mail.google.com",title:"Gmail",enabled:!0,isCustom:!1},{id:"drive",url:"https://drive.google.com",title:"Drive",enabled:!0,isCustom:!1},{id:"docs",url:"https://docs.google.com",title:"Docs",enabled:!0,isCustom:!1},{id:"sheets",url:"https://sheets.google.com",title:"Sheets",enabled:!0,isCustom:!1},{id:"slides",url:"https://slides.google.com",title:"Slides",enabled:!0,isCustom:!1},{id:"youtube",url:"https://www.youtube.com",title:"YouTube",enabled:!0,isCustom:!1},{id:"maps",url:"https://maps.google.com",title:"Maps",enabled:!0,isCustom:!1},{id:"calendar",url:"https://calendar.google.com",title:"Calendar",enabled:!0,isCustom:!1},{id:"translate",url:"https://translate.google.com",title:"Translate",enabled:!0,isCustom:!1},{id:"images",url:"https://www.google.com/imghp",title:"Images",enabled:!0,isCustom:!1},{id:"news",url:"https://news.google.com",title:"News",enabled:!0,isCustom:!1}];t.showQuickShortcuts=t.showQuickShortcuts??!0,t.quickShortcuts=t.quickShortcuts??s,await e.put("settings",t)}return t}async function K(e){const t=await d(),o={...await T(),...e};return await t.put("settings",o),o}async function We(){const e=await d(),t=await e.getAll("savedItems"),s=await e.getAll("topics"),o=await e.getAll("intents"),n=await e.get("settings","main");return{version:"1.0.0",exportedAt:f(),items:t,topics:s,intents:o,settings:n||void 0}}async function Ke(e,t){const s=await d();try{if(console.log(`Resurface Storage: Importing data in ${t} mode`),console.log(`Resurface Storage: Data contains ${e.items.length} items, ${e.topics.length} topics, ${e.intents.length} intents`),!e.items||!e.topics||!e.intents)throw new Error("Invalid backup format: missing required fields");let o=0,n=0,i=0;if(t==="replace"){const a=s.transaction(["savedItems","topics","intents"],"readwrite");await a.objectStore("savedItems").clear(),await a.objectStore("topics").clear(),await a.objectStore("intents").clear(),await a.done,console.log("Resurface Storage: Cleared existing data for replace mode")}for(const a of e.topics)try{t==="merge"?await s.getFromIndex("topics","by-name",a.name)||(await s.add("topics",a),n++):(await s.put("topics",a),n++)}catch(l){console.warn("Resurface Storage: Error importing topic:",a.name,l)}for(const a of e.intents)try{t==="merge"?await s.getFromIndex("intents","by-name",a.name)||(await s.add("intents",a),i++):(await s.put("intents",a),i++)}catch(l){console.warn("Resurface Storage: Error importing intent:",a.name,l)}for(const a of e.items)try{t==="merge"?await s.getFromIndex("savedItems","by-url",a.url)||(await s.add("savedItems",a),o++):(await s.put("savedItems",a),o++)}catch(l){console.warn("Resurface Storage: Error importing item:",a.url,l)}return e.settings&&t==="replace"&&await s.put("settings",e.settings),console.log(`Resurface Storage: Import completed - ${o} items, ${n} topics, ${i} intents`),{success:!0,imported:{items:o,topics:n,intents:i}}}catch(o){throw console.error("Resurface Storage: Import error:",o),o}}async function qe(e){const t=[],s=new Set,o=await Fe(e.url);o&&!s.has(o.name.toLowerCase())&&(t.push(o),s.add(o.name.toLowerCase()));const n=await S(),i=oe(e.title),a=e.referrerQuery?oe(e.referrerQuery):[],l=[...new Set([...a,...i])];for(const u of l){if(t.length>=B)break;const c=Qe(u,n);c&&!s.has(c.name.toLowerCase())&&(t.push(c),s.add(c.name.toLowerCase()))}if(t.length<B&&l.length>0)for(const u of l){if(t.length>=B)break;const c=Re(u);if(!s.has(c.toLowerCase())&&u.length>=3&&He(u)){const r=await R(c,!0);t.push(r),s.add(c.toLowerCase())}}return t}async function Fe(e){const t=I(e);if(j[t])return R(j[t],!0);for(const[s,o]of Object.entries(j))if(s.endsWith(".")&&t.includes(s))return R(o,!0);return null}function Qe(e,t){const s=e.toLowerCase(),o=t.find(i=>i.name.toLowerCase()===s);if(o)return o;const n=t.find(i=>{const a=i.name.toLowerCase();return a.includes(s)||s.includes(a)});return n||null}function He(e){return!(e.length<3||new Set(["app","web","site","page","post","blog","news","article","home","about","contact","help","faq","terms","privacy","login","signup","register","account","profile","settings","search","results","list","view","edit","create","delete","file","files","folder","document","image","video","audio","free","pro","premium","trial","demo","beta","alpha","online","digital","virtual","mobile","desktop","cloud"]).has(e.toLowerCase())||/^\d+$/.test(e))}function ze(e,t){return{type:e,payload:t}}async function h(e,t,s){return chrome.tabs.sendMessage(e,ze(t,s))}chrome.runtime.onInstalled.addListener(async()=>{await V(),await q(),console.log("Resurface installed and initialized")}),chrome.runtime.onStartup.addListener(async()=>{await V(),await q(),console.log("Resurface started")});async function q(){const t=(await chrome.commands.getAll()).find(s=>s.name==="save-tab");t!=null&&t.shortcut&&await K({keyboardShortcut:t.shortcut})}chrome.commands.onCommand.addListener(async e=>{e==="save-tab"?await F():e==="resurface"&&await Ye()}),chrome.omnibox.onInputChanged.addListener(async(e,t)=>{if(e.length<2){t([]);return}const o=(await E(e,6)).map(n=>({content:n.url,description:`<match>${ce(n.title)}</match> <dim>- ${ce(I(n.url))}</dim>`}));t(o)}),chrome.omnibox.onInputEntered.addListener(async(e,t)=>{let s;switch(e.startsWith("http://")||e.startsWith("https://")?s=e:s=chrome.runtime.getURL(`src/dashboard/index.html?search=${encodeURIComponent(e)}`),t){case"currentTab":chrome.tabs.update({url:s});break;case"newForegroundTab":chrome.tabs.create({url:s});break;case"newBackgroundTab":chrome.tabs.create({url:s,active:!1});break}});function ce(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}chrome.action.onClicked.addListener(async e=>{e.id&&await F()});async function le(e){try{await chrome.tabs.sendMessage(e,{type:"PING"})}catch{console.log("Content script not found, injecting..."),await chrome.scripting.executeScript({target:{tabId:e},files:["src/content/index.js"]}),await chrome.scripting.insertCSS({target:{tabId:e},files:["src/content/styles.css"]}),await new Promise(t=>setTimeout(t,100))}}async function Ye(){const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!(e!=null&&e.id)||!e.url){console.log("No active tab or URL");return}if(!e.url.startsWith("http://")&&!e.url.startsWith("https://")){chrome.tabs.create({url:chrome.runtime.getURL("src/dashboard/index.html")});return}try{await le(e.id);const t=await re(),s=await S(),o=await v(),n=t.slice(0,20).map(i=>({id:i.id,title:i.title,url:i.url,favicon:i.favicon,faviconType:i.faviconType,domain:I(i.url),savedAt:$(i.savedAt),topics:s.filter(a=>i.topicIds.includes(a.id)),intents:o.filter(a=>i.intentIds.includes(a.id))}));await h(e.id,"SHOW_SEARCH_MODAL",{items:n})}catch(t){console.error("Error in resurface command:",t)}}async function F(){const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!(e!=null&&e.id)||!e.url){console.log("No active tab or URL");return}if(!e.url.startsWith("http://")&&!e.url.startsWith("https://")){console.log("Cannot save restricted URL:",e.url);return}try{await le(e.id);const t=await Oe(e.url);if(t){await h(e.id,"SHOW_ALREADY_SAVED",{item:t});return}const s=await h(e.id,"EXTRACT_PAGE"),n=(await chrome.tabs.query({windowId:e.windowId})).filter(c=>{var r;return c.id!==e.id&&((r=c.url)==null?void 0:r.startsWith("http"))}).map(c=>c.url).slice(0,10),i=await qe({url:s.url,title:s.title,referrerQuery:s.referrerQuery}),a=await v(),l=await T(),u={pageData:s,suggestedTopics:i,intents:a,siblingTabUrls:n,autoSaveDelay:l.autoSaveDelay};h(e.id,"SHOW_TOAST",u).catch(c=>{console.error("Error showing toast:",c)})}catch(t){console.error("Error in save command:",t)}}chrome.runtime.onMessage.addListener((e,t,s)=>{const o=Je[e.type];return o?(o(e.payload,t).then(s).catch(n=>{console.error(`Error handling ${e.type}:`,n),s({error:n.message})}),!0):(console.warn("Unknown message type:",e.type),!1)});const Je={async SAVE_ITEM(e){console.log("Resurface Background: ========== SAVE_ITEM RECEIVED =========="),console.log("Resurface Background: Payload:",JSON.stringify(e,null,2));try{const{pageData:t,toastResult:s,siblingTabUrls:o}=e;console.log("Resurface Background: Creating item object...");const n={id:p(),url:t.url,title:s.title,favicon:t.favicon,faviconType:t.faviconType,savedAt:f(),lastAccessedAt:f(),referrerQuery:t.referrerQuery,referrerUrl:t.referrerUrl,siblingTabUrls:o,topicIds:s.topicIds,intentIds:s.intentIds,searchText:xe(s.title,t.url,t.referrerQuery)};console.log("Resurface Background: Item created:",JSON.stringify(n,null,2)),console.log("Resurface Background: Calling saveItem...");const i=await Me(n);return console.log("Resurface Background: ========== ITEM SAVED SUCCESSFULLY =========="),console.log("Resurface Background: Saved item:",JSON.stringify(i,null,2)),i}catch(t){throw console.error("Resurface Background: ========== SAVE_ITEM ERROR =========="),console.error("Resurface Background: Error:",t),t}},async SEARCH_ITEMS(e){return E(e.query)},async GET_ALL_ITEMS(){return re()},async GET_ALL_TOPICS(){return S()},async GET_ALL_INTENTS(){return v()},async DELETE_ITEM(e){return Pe(e.id)},async UPDATE_ITEM(e){return W(e.id,e.updates)},async CREATE_TOPIC(e){return Ue(e.name)},async CREATE_INTENT(e){return Ge(e.name,e.emoji)},async RENAME_TOPIC(e){return Be(e.id,e.name)},async DELETE_TOPIC(e){return je(e.id)},async RENAME_INTENT(e){return Ve(e.id,e.name,e.emoji)},async DELETE_INTENT(e){return $e(e.id)},async URL_INPUT(e,t){var a;const{query:s}=e,o=(a=t.tab)==null?void 0:a.id;if(!o||!(await T()).showResurfaceDropdown)return;if(s.length<2){await h(o,"HIDE_DROPDOWN");return}const i=await E(s,5);if(i.length>0){const l=await S(),u=await v(),c=i.map(r=>({id:r.id,title:r.title,url:r.url,favicon:r.favicon,faviconType:r.faviconType,domain:I(r.url),savedAt:$(r.savedAt),topics:l.filter(g=>r.topicIds.includes(g.id)),intents:u.filter(g=>r.intentIds.includes(g.id))}));await h(o,"SHOW_DROPDOWN",{items:c})}else await h(o,"HIDE_DROPDOWN")},async TRIGGER_SAVE(){await F()},async GET_SETTINGS(){return await q(),T()},async UPDATE_SETTINGS(e){return K(e)},async EXPORT_DATA(){return We()},async IMPORT_DATA(e){return Ke(e.data,e.mode)},async OPEN_DASHBOARD(){chrome.tabs.create({url:chrome.runtime.getURL("src/dashboard/index.html")})},async UPDATE_QUICK_SHORTCUTS(e){return K({showQuickShortcuts:e.showQuickShortcuts,quickShortcuts:e.quickShortcuts})}};chrome.tabs.onUpdated.addListener(async(e,t,s)=>{if(t.status==="complete"&&s.url){if(!(await T()).showResurfaceDropdown)return;const n=s.url.match(/google\.[a-z.]+\/search\?.*q=([^&]+)/);if(n){const i=decodeURIComponent(n[1].replace(/\+/g," ")),a=await E(i,5);if(a.length>0)try{const l=await S(),u=await v(),c=a.map(r=>({id:r.id,title:r.title,url:r.url,favicon:r.favicon,faviconType:r.faviconType,domain:I(r.url),savedAt:$(r.savedAt),topics:l.filter(g=>r.topicIds.includes(g.id)),intents:u.filter(g=>r.intentIds.includes(g.id))}));await h(e,"SHOW_GOOGLE_OVERLAY",{items:c,query:i})}catch{}}}})})();
