(function(){"use strict";const M=(e,t)=>t.some(n=>e instanceof n);let K,H;function de(){return K||(K=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function ue(){return H||(H=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const O=new WeakMap,k=new WeakMap,A=new WeakMap;function ge(e){const t=new Promise((n,o)=>{const s=()=>{e.removeEventListener("success",r),e.removeEventListener("error",a)},r=()=>{n(h(e.result)),s()},a=()=>{o(e.error),s()};e.addEventListener("success",r),e.addEventListener("error",a)});return A.set(t,e),t}function me(e){if(O.has(e))return;const t=new Promise((n,o)=>{const s=()=>{e.removeEventListener("complete",r),e.removeEventListener("error",a),e.removeEventListener("abort",a)},r=()=>{n(),s()},a=()=>{o(e.error||new DOMException("AbortError","AbortError")),s()};e.addEventListener("complete",r),e.addEventListener("error",a),e.addEventListener("abort",a)});O.set(e,t)}let j={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return O.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return h(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function q(e){j=e(j)}function fe(e){return ue().includes(e)?function(...t){return e.apply(N(this),t),h(this.request)}:function(...t){return h(e.apply(N(this),t))}}function we(e){return typeof e=="function"?fe(e):(e instanceof IDBTransaction&&me(e),M(e,de())?new Proxy(e,j):e)}function h(e){if(e instanceof IDBRequest)return ge(e);if(k.has(e))return k.get(e);const t=we(e);return t!==e&&(k.set(e,t),A.set(t,e)),t}const N=e=>A.get(e);function D(e,t,{blocked:n,upgrade:o,blocking:s,terminated:r}={}){const a=indexedDB.open(e,t),l=h(a);return o&&a.addEventListener("upgradeneeded",d=>{o(h(a.result),d.oldVersion,d.newVersion,h(a.transaction),d)}),n&&a.addEventListener("blocked",d=>n(d.oldVersion,d.newVersion,d)),l.then(d=>{r&&d.addEventListener("close",()=>r()),s&&d.addEventListener("versionchange",c=>s(c.oldVersion,c.newVersion,c))}).catch(()=>{}),l}const he=["get","getKey","getAll","getAllKeys","count"],pe=["put","add","delete","clear"],P=new Map;function z(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(P.get(t))return P.get(t);const n=t.replace(/FromIndex$/,""),o=t!==n,s=pe.includes(n);if(!(n in(o?IDBIndex:IDBObjectStore).prototype)||!(s||he.includes(n)))return;const r=async function(a,...l){const d=this.transaction(a,s?"readwrite":"readonly");let c=d.store;return o&&(c=c.index(l.shift())),(await Promise.all([c[n](...l),s&&d.done]))[0]};return P.set(t,r),r}q(e=>({...e,get:(t,n,o)=>z(t,n)||e.get(t,n,o),has:(t,n)=>!!z(t,n)||e.has(t,n)}));const ye=["continue","continuePrimaryKey","advance"],Q={},U=new WeakMap,J=new WeakMap,Ie={get(e,t){if(!ye.includes(t))return e[t];let n=Q[t];return n||(n=Q[t]=function(...o){U.set(this,J.get(this)[t](...o))}),n}};async function*be(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;t=t;const n=new Proxy(t,Ie);for(J.set(n,t),A.set(n,N(t));t;)yield n,t=await(U.get(n)||t.continue()),U.delete(n)}function X(e,t){return t===Symbol.asyncIterator&&M(e,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&M(e,[IDBIndex,IDBObjectStore])}q(e=>({...e,get(t,n,o){return X(t,n)?be:e.get(t,n,o)},has(t,n){return X(t,n)||e.has(t,n)}}));const Se=[{name:"Read Later",emoji:"üìñ"},{name:"Reference",emoji:"üìå"},{name:"Share",emoji:"üîó"},{name:"Project",emoji:"üìÅ"}],Y=["#818cf8","#34d399","#fbbf24","#f87171","#38bdf8","#a78bfa","#fb7185","#2dd4bf"],_={"github.com":"Development","gitlab.com":"Development","stackoverflow.com":"Development","dev.to":"Development","npmjs.com":"Development","docs.python.org":"Development","developer.mozilla.org":"Development","medium.com":"Articles","substack.com":"Articles","hashnode.com":"Articles","blog.":"Articles","youtube.com":"Videos","vimeo.com":"Videos","twitch.tv":"Videos","twitter.com":"Social","x.com":"Social","linkedin.com":"Social","reddit.com":"Social","facebook.com":"Social","news.ycombinator.com":"Tech News","techcrunch.com":"Tech News","theverge.com":"Tech News","arstechnica.com":"Tech News","wired.com":"Tech News","arxiv.org":"Research","scholar.google.com":"Research","researchgate.net":"Research","nature.com":"Research","sciencedirect.com":"Research","figma.com":"Design","dribbble.com":"Design","behance.net":"Design","awwwards.com":"Design","openai.com":"AI","anthropic.com":"AI","huggingface.co":"AI"},B=3,G="resurface",Z=1,ve=new Set(["the","a","an","and","or","but","in","on","at","to","for","of","with","by","from","is","are","was","were","be","been","being","have","has","had","do","does","did","will","would","could","should","may","might","must","shall","can","need","how","what","when","where","why","who","which","this","that","these","those","i","you","he","she","it","we","they","my","your","his","her","its","our","their","me","him","us","them","just","only","also","very","too","so","than","then","now","here","there","all","each","every","both","few","more","most","other","some","such","no","not","any","new","first","last","long","great","little","own","same","right","big","high","different","small","large","next","early","young","important","public","bad","good","best","well","way","use","using","used","get","getting","got","make","making","made","part","full","complete","guide","tutorial","introduction","intro","overview"]);let R;const Te=new Uint8Array(16);function Ae(){if(!R&&(R=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!R))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return R(Te)}const u=[];for(let e=0;e<256;++e)u.push((e+256).toString(16).slice(1));function De(e,t=0){return u[e[t+0]]+u[e[t+1]]+u[e[t+2]]+u[e[t+3]]+"-"+u[e[t+4]]+u[e[t+5]]+"-"+u[e[t+6]]+u[e[t+7]]+"-"+u[e[t+8]]+u[e[t+9]]+"-"+u[e[t+10]]+u[e[t+11]]+u[e[t+12]]+u[e[t+13]]+u[e[t+14]]+u[e[t+15]]}const ee={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function Re(e,t,n){if(ee.randomUUID&&!e)return ee.randomUUID();e=e||{};const o=e.random||(e.rng||Ae)();return o[6]=o[6]&15|64,o[8]=o[8]&63|128,De(o)}function p(){return Re()}function f(){return Date.now()}function b(e){try{const{hostname:t}=new URL(e);return t.replace("www.","")}catch{return""}}function te(e){return e.toLowerCase().replace(/[^a-z0-9\s]/g," ").split(/\s+/).filter(t=>t.length>2&&!ve.has(t)&&!/^\d+$/.test(t)).slice(0,5)}function Ee(e){return e.charAt(0).toUpperCase()+e.slice(1)}function $(e){const t=Math.floor((Date.now()-e)/1e3);if(t<60)return"Just now";const n=Math.floor(t/60);if(n<60)return`${n}m ago`;const o=Math.floor(n/60);if(o<24)return`${o}h ago`;const s=Math.floor(o/24);if(s<7)return`${s}d ago`;const r=Math.floor(s/7);if(r<4)return`${r}w ago`;const a=Math.floor(s/30);return a<12?`${a}mo ago`:`${Math.floor(s/365)}y ago`}function xe(e,t,n){return[e.toLowerCase(),t.toLowerCase(),(n==null?void 0:n.toLowerCase())||""].join(" ").trim()}function ne(e,t){const n=e.filter(o=>!t.includes(o));return n.length===0?e[Math.floor(Math.random()*e.length)]:n[Math.floor(Math.random()*n.length)]}const oe="tabmind";let y=null;async function g(){return console.log("Resurface Storage: ensureDb called, db exists:",!!y),y||(console.log("Resurface Storage: DB not initialized, calling initStorage..."),await V(),console.log("Resurface Storage: initStorage completed, db exists:",!!y)),y}async function V(){y||(await Ce(),y=await D(G,Z,{upgrade(e,t,n){if(console.log(`Resurface Storage: Upgrading DB from v${t} to v${n}`),!e.objectStoreNames.contains("savedItems")){const o=e.createObjectStore("savedItems",{keyPath:"id"});o.createIndex("by-url","url"),o.createIndex("by-savedAt","savedAt"),o.createIndex("by-searchText","searchText")}e.objectStoreNames.contains("topics")||e.createObjectStore("topics",{keyPath:"id"}).createIndex("by-name","name"),e.objectStoreNames.contains("intents")||e.createObjectStore("intents",{keyPath:"id"}).createIndex("by-name","name"),e.objectStoreNames.contains("settings")||e.createObjectStore("settings",{keyPath:"id"})}}),await Le())}async function Ce(){try{if(!(await indexedDB.databases()).some(i=>i.name===oe)){console.log("Resurface Storage: No old TabMind database found, skipping migration");return}console.log("Resurface Storage: Found old TabMind database, starting migration...");const n=await D(oe,1);let o=!1;try{const i=await D(G,1);o=(await i.getAll("savedItems")).length>0,i.close()}catch{}if(o){console.log("Resurface Storage: New database already has data, skipping migration"),n.close();return}const s=await n.getAll("savedItems"),r=await n.getAll("topics"),a=await n.getAll("intents"),l=await n.get("settings","main");console.log(`Resurface Storage: Migrating ${s.length} items, ${r.length} topics, ${a.length} intents`),n.close();const d=await D(G,Z,{upgrade(i){if(!i.objectStoreNames.contains("savedItems")){const m=i.createObjectStore("savedItems",{keyPath:"id"});m.createIndex("by-url","url"),m.createIndex("by-savedAt","savedAt"),m.createIndex("by-searchText","searchText")}i.objectStoreNames.contains("topics")||i.createObjectStore("topics",{keyPath:"id"}).createIndex("by-name","name"),i.objectStoreNames.contains("intents")||i.createObjectStore("intents",{keyPath:"id"}).createIndex("by-name","name"),i.objectStoreNames.contains("settings")||i.createObjectStore("settings",{keyPath:"id"})}}),c=d.transaction(["savedItems","topics","intents","settings"],"readwrite");for(const i of s)await c.objectStore("savedItems").put(i);for(const i of r)await c.objectStore("topics").put(i);for(const i of a)await c.objectStore("intents").put(i);l&&await c.objectStore("settings").put(l),await c.done,d.close(),console.log("Resurface Storage: Migration completed successfully!")}catch(e){console.error("Resurface Storage: Migration error (non-fatal):",e)}}const I=[{url:"https://mail.google.com",title:"Gmail - Email by Google",searchKeywords:"gmail email mail google inbox messages compose send receive"},{url:"https://www.youtube.com",title:"YouTube - Video Platform",searchKeywords:"youtube videos watch streaming music tutorials entertainment"},{url:"https://drive.google.com",title:"Google Drive - Cloud Storage",searchKeywords:"drive google storage files documents backup cloud sync"},{url:"https://maps.google.com",title:"Google Maps - Navigation & Places",searchKeywords:"maps google directions navigation places location street view"},{url:"https://calendar.google.com",title:"Google Calendar - Schedule & Events",searchKeywords:"calendar google schedule events meetings reminders appointments"},{url:"https://translate.google.com",title:"Google Translate - Language Translation",searchKeywords:"translate google translation language translator convert"},{url:"https://news.google.com",title:"Google News - Headlines & Stories",searchKeywords:"news google headlines articles current events world"},{url:"https://images.google.com",title:"Google Images - Image Search",searchKeywords:"images google photos pictures image search reverse"}];async function Le(){const e=await g();if((await e.getAll("intents")).length===0)for(const s of Se)await e.add("intents",{id:p(),name:s.name,emoji:s.emoji,createdAt:f(),itemCount:0});if(await e.get("settings","main")||await e.add("settings",{id:"main",keyboardShortcut:"Cmd+Shift+S",autoSaveDelay:5e3,showResurfaceDropdown:!0,defaultIntentId:null}),(await e.getAll("savedItems")).length===0){console.log("Resurface Storage: Adding default saved pages for new user...");const s=await se(e,"Quick Access"),r=await se(e,"Google"),l=(await e.getAll("intents")).find(c=>c.name==="Quick Reference"),d=f();for(let c=0;c<I.length;c++){const i=I[c],m=new URL(i.url).hostname,He=[i.title,i.url,i.searchKeywords].join(" ").toLowerCase(),le=d-c*1e3,qe={id:p(),url:i.url,title:i.title,favicon:`https://www.google.com/s2/favicons?domain=${m}&sz=64`,faviconType:"url",savedAt:le,lastAccessedAt:le,referrerQuery:null,referrerUrl:null,siblingTabUrls:[],topicIds:[s.id,r.id],intentIds:l?[l.id]:[],searchText:He};await e.add("savedItems",qe)}s.itemCount=I.length,r.itemCount=I.length,await e.put("topics",s),await e.put("topics",r),l&&(l.itemCount=I.length,await e.put("intents",l)),console.log(`Resurface Storage: Added ${I.length} default saved pages`)}}async function se(e,t){const n=await e.getFromIndex("topics","by-name",t);if(n)return n;const s=(await e.getAll("topics")).map(a=>a.color),r={id:p(),name:t,color:ne(Y,s),isAutoGenerated:!1,createdAt:f(),itemCount:0};return await e.add("topics",r),r}async function Me(e){console.log("Resurface Storage: saveItem called with:",e.url);try{const t=await g();console.log("Resurface Storage: Got database reference"),console.log("Resurface Storage: Checking for existing item with URL:",e.url);const n=await t.getFromIndex("savedItems","by-url",e.url);if(console.log("Resurface Storage: Existing item found:",!!n),n){console.log("Resurface Storage: Updating existing item");const o={...n,...e,id:n.id,savedAt:n.savedAt,lastAccessedAt:f()};return await t.put("savedItems",o),console.log("Resurface Storage: Item updated successfully"),o}return console.log("Resurface Storage: Adding new item..."),await t.add("savedItems",e),console.log("Resurface Storage: Item added to database"),console.log("Resurface Storage: Updating topic counts for:",e.topicIds),await C(e.topicIds,1),console.log("Resurface Storage: Updating intent counts for:",e.intentIds),await L(e.intentIds,1),console.log("Resurface Storage: saveItem completed successfully"),e}catch(t){throw console.error("Resurface Storage: Error in saveItem:",t),t}}async function Oe(e){return(await g()).getFromIndex("savedItems","by-url",e)}async function ae(){return(await(await g()).getAll("savedItems")).sort((n,o)=>o.savedAt-n.savedAt)}async function E(e,t=10){const n=await g(),o=e.toLowerCase().trim();if(!o)return[];const s=await n.getAll("savedItems"),r=o.split(/\s+/);return s.filter(a=>r.some(l=>a.searchText.includes(l))).sort((a,l)=>{const d=r.filter(i=>a.searchText.includes(i)).length,c=r.filter(i=>l.searchText.includes(i)).length;return c!==d?c-d:l.savedAt-a.savedAt}).slice(0,t)}async function ke(e,t){const n=await g(),o=await n.get("savedItems",e);if(!o)return null;const s=o.topicIds,r=o.intentIds,a={...o,...t,lastAccessedAt:f()};if(await n.put("savedItems",a),t.topicIds){const l=s.filter(c=>!t.topicIds.includes(c)),d=t.topicIds.filter(c=>!s.includes(c));await C(l,-1),await C(d,1)}if(t.intentIds){const l=r.filter(c=>!t.intentIds.includes(c)),d=t.intentIds.filter(c=>!r.includes(c));await L(l,-1),await L(d,1)}return a}async function je(e){const t=await g(),n=await t.get("savedItems",e);return n?(await t.delete("savedItems",e),await C(n.topicIds,-1),await L(n.intentIds,-1),!0):!1}async function S(){return(await(await g()).getAll("topics")).sort((n,o)=>o.itemCount-n.itemCount)}async function x(e,t=!1){const n=await g(),o=e.trim(),s=await n.getFromIndex("topics","by-name",o);if(s)return s;const a=(await n.getAll("topics")).map(d=>d.color),l={id:p(),name:o,color:ne(Y,a),isAutoGenerated:t,createdAt:f(),itemCount:0};return await n.add("topics",l),l}async function Ne(e){return x(e,!1)}async function C(e,t){const n=await g();for(const o of e){const s=await n.get("topics",o);s&&(s.itemCount=Math.max(0,s.itemCount+t),await n.put("topics",s))}}async function v(){return(await(await g()).getAll("intents")).sort((n,o)=>o.itemCount-n.itemCount)}async function Pe(e,t){const n=await g(),o={id:p(),name:e.trim(),emoji:t,createdAt:f(),itemCount:0};return await n.add("intents",o),o}async function L(e,t){const n=await g();for(const o of e){const s=await n.get("intents",o);s&&(s.itemCount=Math.max(0,s.itemCount+t),await n.put("intents",s))}}async function T(){return await(await g()).get("settings","main")}async function re(e){const t=await g(),o={...await T(),...e};return await t.put("settings",o),o}async function Ue(){const e=await g(),t=await e.getAll("savedItems"),n=await e.getAll("topics"),o=await e.getAll("intents"),s=await e.get("settings","main");return{version:"1.0.0",exportedAt:f(),items:t,topics:n,intents:o,settings:s||void 0}}async function _e(e,t){const n=await g();try{if(console.log(`Resurface Storage: Importing data in ${t} mode`),console.log(`Resurface Storage: Data contains ${e.items.length} items, ${e.topics.length} topics, ${e.intents.length} intents`),!e.items||!e.topics||!e.intents)throw new Error("Invalid backup format: missing required fields");let o=0,s=0,r=0;if(t==="replace"){const a=n.transaction(["savedItems","topics","intents"],"readwrite");await a.objectStore("savedItems").clear(),await a.objectStore("topics").clear(),await a.objectStore("intents").clear(),await a.done,console.log("Resurface Storage: Cleared existing data for replace mode")}for(const a of e.topics)try{t==="merge"?await n.getFromIndex("topics","by-name",a.name)||(await n.add("topics",a),s++):(await n.put("topics",a),s++)}catch(l){console.warn("Resurface Storage: Error importing topic:",a.name,l)}for(const a of e.intents)try{t==="merge"?await n.getFromIndex("intents","by-name",a.name)||(await n.add("intents",a),r++):(await n.put("intents",a),r++)}catch(l){console.warn("Resurface Storage: Error importing intent:",a.name,l)}for(const a of e.items)try{t==="merge"?await n.getFromIndex("savedItems","by-url",a.url)||(await n.add("savedItems",a),o++):(await n.put("savedItems",a),o++)}catch(l){console.warn("Resurface Storage: Error importing item:",a.url,l)}return e.settings&&t==="replace"&&await n.put("settings",e.settings),console.log(`Resurface Storage: Import completed - ${o} items, ${s} topics, ${r} intents`),{success:!0,imported:{items:o,topics:s,intents:r}}}catch(o){throw console.error("Resurface Storage: Import error:",o),o}}async function Be(e){const t=[],n=new Set,o=await Ge(e.url);o&&!n.has(o.name.toLowerCase())&&(t.push(o),n.add(o.name.toLowerCase()));const s=await S(),r=te(e.title),a=e.referrerQuery?te(e.referrerQuery):[],l=[...new Set([...a,...r])];for(const d of l){if(t.length>=B)break;const c=$e(d,s);c&&!n.has(c.name.toLowerCase())&&(t.push(c),n.add(c.name.toLowerCase()))}if(t.length<B&&l.length>0)for(const d of l){if(t.length>=B)break;const c=Ee(d);if(!n.has(c.toLowerCase())&&d.length>=3&&Ve(d)){const i=await x(c,!0);t.push(i),n.add(c.toLowerCase())}}return t}async function Ge(e){const t=b(e);if(_[t])return x(_[t],!0);for(const[n,o]of Object.entries(_))if(n.endsWith(".")&&t.includes(n))return x(o,!0);return null}function $e(e,t){const n=e.toLowerCase(),o=t.find(r=>r.name.toLowerCase()===n);if(o)return o;const s=t.find(r=>{const a=r.name.toLowerCase();return a.includes(n)||n.includes(a)});return s||null}function Ve(e){return!(e.length<3||new Set(["app","web","site","page","post","blog","news","article","home","about","contact","help","faq","terms","privacy","login","signup","register","account","profile","settings","search","results","list","view","edit","create","delete","file","files","folder","document","image","video","audio","free","pro","premium","trial","demo","beta","alpha","online","digital","virtual","mobile","desktop","cloud"]).has(e.toLowerCase())||/^\d+$/.test(e))}function We(e,t){return{type:e,payload:t}}async function w(e,t,n){return chrome.tabs.sendMessage(e,We(t,n))}chrome.runtime.onInstalled.addListener(async()=>{await V(),await W(),console.log("Resurface installed and initialized")}),chrome.runtime.onStartup.addListener(async()=>{await V(),await W(),console.log("Resurface started")});async function W(){const t=(await chrome.commands.getAll()).find(n=>n.name==="save-tab");t!=null&&t.shortcut&&await re({keyboardShortcut:t.shortcut})}chrome.commands.onCommand.addListener(async e=>{e==="save-tab"?await F():e==="resurface"&&await Fe()}),chrome.omnibox.onInputChanged.addListener(async(e,t)=>{if(e.length<2){t([]);return}const o=(await E(e,6)).map(s=>({content:s.url,description:`<match>${ie(s.title)}</match> <dim>- ${ie(b(s.url))}</dim>`}));t(o)}),chrome.omnibox.onInputEntered.addListener(async(e,t)=>{let n;switch(e.startsWith("http://")||e.startsWith("https://")?n=e:n=chrome.runtime.getURL(`src/dashboard/index.html?search=${encodeURIComponent(e)}`),t){case"currentTab":chrome.tabs.update({url:n});break;case"newForegroundTab":chrome.tabs.create({url:n});break;case"newBackgroundTab":chrome.tabs.create({url:n,active:!1});break}});function ie(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}chrome.action.onClicked.addListener(async e=>{e.id&&await F()});async function ce(e){try{await chrome.tabs.sendMessage(e,{type:"PING"})}catch{console.log("Content script not found, injecting..."),await chrome.scripting.executeScript({target:{tabId:e},files:["src/content/index.js"]}),await chrome.scripting.insertCSS({target:{tabId:e},files:["src/content/styles.css"]}),await new Promise(t=>setTimeout(t,100))}}async function Fe(){const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!(e!=null&&e.id)||!e.url){console.log("No active tab or URL");return}if(!e.url.startsWith("http://")&&!e.url.startsWith("https://")){chrome.tabs.create({url:chrome.runtime.getURL("src/dashboard/index.html")});return}try{await ce(e.id);const t=await ae(),n=await S(),o=await v(),s=t.slice(0,20).map(r=>({id:r.id,title:r.title,url:r.url,favicon:r.favicon,faviconType:r.faviconType,domain:b(r.url),savedAt:$(r.savedAt),topics:n.filter(a=>r.topicIds.includes(a.id)),intents:o.filter(a=>r.intentIds.includes(a.id))}));await w(e.id,"SHOW_SEARCH_MODAL",{items:s})}catch(t){console.error("Error in resurface command:",t)}}async function F(){const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!(e!=null&&e.id)||!e.url){console.log("No active tab or URL");return}if(!e.url.startsWith("http://")&&!e.url.startsWith("https://")){console.log("Cannot save restricted URL:",e.url);return}try{await ce(e.id);const t=await Oe(e.url);if(t){await w(e.id,"SHOW_ALREADY_SAVED",{item:t});return}const n=await w(e.id,"EXTRACT_PAGE"),s=(await chrome.tabs.query({windowId:e.windowId})).filter(c=>{var i;return c.id!==e.id&&((i=c.url)==null?void 0:i.startsWith("http"))}).map(c=>c.url).slice(0,10),r=await Be({url:n.url,title:n.title,referrerQuery:n.referrerQuery}),a=await v(),l=await T(),d={pageData:n,suggestedTopics:r,intents:a,siblingTabUrls:s,autoSaveDelay:l.autoSaveDelay};w(e.id,"SHOW_TOAST",d).catch(c=>{console.error("Error showing toast:",c)})}catch(t){console.error("Error in save command:",t)}}chrome.runtime.onMessage.addListener((e,t,n)=>{const o=Ke[e.type];return o?(o(e.payload,t).then(n).catch(s=>{console.error(`Error handling ${e.type}:`,s),n({error:s.message})}),!0):(console.warn("Unknown message type:",e.type),!1)});const Ke={async SAVE_ITEM(e){console.log("Resurface Background: ========== SAVE_ITEM RECEIVED =========="),console.log("Resurface Background: Payload:",JSON.stringify(e,null,2));try{const{pageData:t,toastResult:n,siblingTabUrls:o}=e;console.log("Resurface Background: Creating item object...");const s={id:p(),url:t.url,title:n.title,favicon:t.favicon,faviconType:t.faviconType,savedAt:f(),lastAccessedAt:f(),referrerQuery:t.referrerQuery,referrerUrl:t.referrerUrl,siblingTabUrls:o,topicIds:n.topicIds,intentIds:n.intentIds,searchText:xe(n.title,t.url,t.referrerQuery)};console.log("Resurface Background: Item created:",JSON.stringify(s,null,2)),console.log("Resurface Background: Calling saveItem...");const r=await Me(s);return console.log("Resurface Background: ========== ITEM SAVED SUCCESSFULLY =========="),console.log("Resurface Background: Saved item:",JSON.stringify(r,null,2)),r}catch(t){throw console.error("Resurface Background: ========== SAVE_ITEM ERROR =========="),console.error("Resurface Background: Error:",t),t}},async SEARCH_ITEMS(e){return E(e.query)},async GET_ALL_ITEMS(){return ae()},async GET_ALL_TOPICS(){return S()},async GET_ALL_INTENTS(){return v()},async DELETE_ITEM(e){return je(e.id)},async UPDATE_ITEM(e){return ke(e.id,e.updates)},async CREATE_TOPIC(e){return Ne(e.name)},async CREATE_INTENT(e){return Pe(e.name,e.emoji)},async URL_INPUT(e,t){var a;const{query:n}=e,o=(a=t.tab)==null?void 0:a.id;if(!o||!(await T()).showResurfaceDropdown)return;if(n.length<2){await w(o,"HIDE_DROPDOWN");return}const r=await E(n,5);if(r.length>0){const l=await S(),d=await v(),c=r.map(i=>({id:i.id,title:i.title,url:i.url,favicon:i.favicon,faviconType:i.faviconType,domain:b(i.url),savedAt:$(i.savedAt),topics:l.filter(m=>i.topicIds.includes(m.id)),intents:d.filter(m=>i.intentIds.includes(m.id))}));await w(o,"SHOW_DROPDOWN",{items:c})}else await w(o,"HIDE_DROPDOWN")},async TRIGGER_SAVE(){await F()},async GET_SETTINGS(){return await W(),T()},async UPDATE_SETTINGS(e){return re(e)},async EXPORT_DATA(){return Ue()},async IMPORT_DATA(e){return _e(e.data,e.mode)}};chrome.tabs.onUpdated.addListener(async(e,t,n)=>{if(t.status==="complete"&&n.url){if(!(await T()).showResurfaceDropdown)return;const s=n.url.match(/google\.[a-z.]+\/search\?.*q=([^&]+)/);if(s){const r=decodeURIComponent(s[1].replace(/\+/g," ")),a=await E(r,5);if(a.length>0)try{const l=await S(),d=await v(),c=a.map(i=>({id:i.id,title:i.title,url:i.url,favicon:i.favicon,faviconType:i.faviconType,domain:b(i.url),savedAt:$(i.savedAt),topics:l.filter(m=>i.topicIds.includes(m.id)),intents:d.filter(m=>i.intentIds.includes(m.id))}));await w(e,"SHOW_GOOGLE_OVERLAY",{items:c,query:r})}catch{}}}})})();
