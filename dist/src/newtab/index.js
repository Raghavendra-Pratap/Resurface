import{s as w}from"../../messages.js";let M=[],I=[],S=[],f=[],p=[],y=null,u="none",c=-1;document.addEventListener("DOMContentLoaded",async()=>{await F(),await z(),A(),_(),R(),C(),window.addEventListener("resize",C),U()});function C(){const i=window.innerHeight-140-80-180,n=Math.max(200,Math.min(400,i/2)),r=document.getElementById("history-tray"),a=document.getElementById("results-tray");r&&(r.style.maxHeight=`${n}px`),a&&(a.style.maxHeight=`${n}px`)}async function z(){try{y=await w("GET_SETTINGS",void 0)}catch(t){console.error("Error loading settings:",t)}}function A(){if(!y)return;const t=document.getElementById("newtab-logo");t&&(t.style.display=y.newTabShowLogo!==!1?"flex":"none"),N()}function N(){const t=document.getElementById("quick-links");if(!t||!y)return;t.innerHTML="";const e={gemini:{name:"Gemini",url:"https://gemini.google.com",icon:"gemini",className:"gemini"},gmail:{name:"Gmail",url:"https://mail.google.com",icon:"gmail",className:"gmail"},drive:{name:"Drive",url:"https://drive.google.com",icon:"drive",className:"drive"},docs:{name:"Docs",url:"https://docs.google.com",icon:"docs",className:"docs"},sheets:{name:"Sheets",url:"https://sheets.google.com",icon:"sheets",className:"sheets"},slides:{name:"Slides",url:"https://slides.google.com",icon:"slides",className:"slides"},youtube:{name:"YouTube",url:"https://youtube.com",icon:"youtube",className:"youtube"},maps:{name:"Maps",url:"https://maps.google.com",icon:"maps",className:"maps"},calendar:{name:"Calendar",url:"https://calendar.google.com",icon:"calendar",className:"calendar"},translate:{name:"Translate",url:"https://translate.google.com",icon:"translate",className:"translate"}};(y.newTabEnabledShortcuts||[]).forEach(i=>{const n=e[i];if(n){const r=q(n.name,n.url,n.className);t.appendChild(r)}}),(y.newTabCustomLinks||[]).forEach(i=>{const n=D(i);t.appendChild(n)})}function q(t,e,s){const o=document.createElement("a");o.href=e,o.className="newtab-quick-link",o.title=t;const i=document.createElement("div");i.className=`newtab-quick-icon ${s}`;const n=V(s);i.innerHTML=n;const r=document.createElement("span");return r.textContent=t,o.appendChild(i),o.appendChild(r),o}function D(t){const e=document.createElement("a");e.href=t.url,e.className="newtab-quick-link",e.title=t.name;const s=document.createElement("div");s.className="newtab-quick-icon custom",t.icon?t.icon.length<=2||t.icon.startsWith("http")?s.textContent=t.icon:s.innerHTML=t.icon:s.textContent=t.name.charAt(0).toUpperCase();const o=document.createElement("span");return o.textContent=t.name,e.appendChild(s),e.appendChild(o),e}function V(t){return{gemini:'<svg viewBox="0 0 24 24"><path d="M12 2L2 12l10 10 10-10L12 2zm0 3.5L18.5 12 12 18.5 5.5 12 12 5.5z" fill="currentColor"/><circle cx="12" cy="12" r="3" fill="currentColor"/></svg>',gmail:'<svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z" fill="currentColor"/></svg>',drive:'<svg viewBox="0 0 24 24"><path d="M7.71 3.5L1.15 15l3.43 6h13.71l3.43-6L15.15 3.5H7.71zm.79 1.5h5.57l5.15 9h-5.57l-5.15-9zm-1.58 9.5L2.73 15l2.29 4h10.58l-2.29-4H6.92z" fill="currentColor"/></svg>',docs:'<svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z" stroke="currentColor" stroke-width="2" fill="none"/><path d="M14 2v6h6" stroke="currentColor" stroke-width="2" fill="none"/><line x1="8" y1="13" x2="16" y2="13" stroke="currentColor" stroke-width="2"/><line x1="8" y1="17" x2="13" y2="17" stroke="currentColor" stroke-width="2"/></svg>',sheets:'<svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2" fill="none"/><line x1="3" y1="9" x2="21" y2="9" stroke="currentColor" stroke-width="2"/><line x1="3" y1="15" x2="21" y2="15" stroke="currentColor" stroke-width="2"/><line x1="9" y1="3" x2="9" y2="21" stroke="currentColor" stroke-width="2"/></svg>',slides:'<svg viewBox="0 0 24 24"><rect x="2" y="6" width="20" height="12" rx="2" stroke="currentColor" stroke-width="2" fill="none"/><polygon points="10,9 10,15 15,12" fill="currentColor"/></svg>',youtube:'<svg viewBox="0 0 24 24"><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z" fill="currentColor"/></svg>',maps:'<svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" fill="currentColor"/></svg>',calendar:'<svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2" fill="none"/><line x1="3" y1="10" x2="21" y2="10" stroke="currentColor" stroke-width="2"/><line x1="8" y1="2" x2="8" y2="6" stroke="currentColor" stroke-width="2"/><line x1="16" y1="2" x2="16" y2="6" stroke="currentColor" stroke-width="2"/></svg>',translate:'<svg viewBox="0 0 24 24"><path d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z" fill="currentColor"/></svg>'}[t]||'<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="currentColor"/></svg>'}async function R(){try{const t=await chrome.commands.getAll(),e=document.querySelector(".newtab-hints");if(!e)return;const s=t.find(h=>h.name==="save-tab"),o=t.find(h=>h.name==="resurface"),i=(s==null?void 0:s.shortcut)||"Not set",n=(o==null?void 0:o.shortcut)||"Not set";e.innerHTML=`
      <button id="open-dashboard-btn" class="newtab-dashboard-btn">Open Dashboard</button>
      <span class="newtab-hint-item" title="Click to customize">
        ${L(i)} Save current tab
      </span>
      <span class="newtab-hint-item" title="Click to customize">
        ${L(n)} Search saved tabs
      </span>
      <a href="chrome://extensions/shortcuts" class="newtab-hint-customize" id="customize-shortcuts">
        Customize shortcuts
      </a>
    `;const r=document.getElementById("open-dashboard-btn");r&&r.addEventListener("click",()=>{window.location.href=chrome.runtime.getURL("src/dashboard/index.html")});const a=document.getElementById("customize-shortcuts");a==null||a.addEventListener("click",h=>{h.preventDefault(),G()})}catch(t){console.error("Error fetching shortcuts:",t)}}function L(t){return!t||t==="Not set"?'<span class="newtab-shortcut-notset">Not set</span>':t.replace("Command","⌘").replace("Cmd","⌘").replace("MacCtrl","⌃").replace("Ctrl","⌃").replace("Alt","⌥").replace("Shift","⇧").split("+").map(s=>`<kbd>${s.trim()}</kbd>`).join("")}function G(){var s,o,i;const t=document.createElement("div");t.className="newtab-shortcut-modal",t.innerHTML=`
    <div class="newtab-shortcut-modal-content">
      <div class="newtab-shortcut-modal-header">
        <h3>Customize Keyboard Shortcuts</h3>
        <button class="newtab-shortcut-modal-close" id="close-modal">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="newtab-shortcut-modal-body">
        <p>To customize Resurface's keyboard shortcuts:</p>
        <ol>
          <li>Open Chrome and go to <code>chrome://extensions</code></li>
          <li>Click the <strong>menu icon</strong> (☰) in the top-left</li>
          <li>Select <strong>"Keyboard shortcuts"</strong></li>
          <li>Find <strong>Resurface</strong> and set your preferred shortcuts</li>
        </ol>
        <div class="newtab-shortcut-modal-actions">
          <button class="newtab-btn newtab-btn-secondary" id="copy-url">
            Copy URL
          </button>
          <button class="newtab-btn newtab-btn-primary" id="close-modal-btn">
            Got it
          </button>
        </div>
      </div>
    </div>
  `,document.body.appendChild(t),requestAnimationFrame(()=>t.classList.add("visible"));const e=()=>{t.classList.remove("visible"),setTimeout(()=>t.remove(),200)};(s=t.querySelector("#close-modal"))==null||s.addEventListener("click",e),(o=t.querySelector("#close-modal-btn"))==null||o.addEventListener("click",e),t.addEventListener("click",n=>{n.target===t&&e()}),(i=t.querySelector("#copy-url"))==null||i.addEventListener("click",()=>{navigator.clipboard.writeText("chrome://extensions/shortcuts");const n=t.querySelector("#copy-url");n&&(n.textContent="Copied!",setTimeout(()=>n.textContent="Copy URL",2e3))})}function U(){const t=document.getElementById("search-input");if(!t)return;const e=()=>{document.dispatchEvent(new KeyboardEvent("keydown",{key:"Escape",code:"Escape",keyCode:27,which:27,bubbles:!0,cancelable:!0}))},s=()=>{t.focus(),t.select()};e(),s(),requestAnimationFrame(()=>{e(),s()}),requestAnimationFrame(()=>requestAnimationFrame(s)),[0,10,20,50,100,150,200,300,500].forEach(a=>setTimeout(()=>{e(),s()},a));let i=0;const n=10,r=setInterval(()=>{i++,document.activeElement!==t&&(e(),s()),i>=n&&clearInterval(r)},100);window.addEventListener("focus",()=>{e(),setTimeout(s,0),setTimeout(s,50)}),document.addEventListener("click",a=>{a.target.closest("a, button, input, select, textarea, .newtab-result-item, .newtab-history-item, .newtab-quick-link")||s()}),document.addEventListener("keydown",a=>{a.key.length===1&&!a.ctrlKey&&!a.metaKey&&!a.altKey&&document.activeElement!==t&&s()})}async function F(){try{M=await w("GET_ALL_ITEMS")||[],I=await w("GET_ALL_TOPICS")||[],S=await w("GET_ALL_INTENTS")||[]}catch(t){console.error("Error loading data:",t)}}function _(){const t=document.getElementById("search-input"),e=document.getElementById("results-tray"),s=document.getElementById("history-tray"),o=document.getElementById("open-dashboard-btn");o&&o.addEventListener("click",()=>{window.location.href=chrome.runtime.getURL("src/dashboard/index.html")});let i=null;t.addEventListener("input",()=>{i&&clearTimeout(i),i=setTimeout(()=>{const n=t.value.trim();x(n)},100)}),t.addEventListener("keydown",n=>{const r=s.querySelectorAll(".newtab-history-item"),a=e.querySelectorAll(".newtab-result-item"),h=r.length,b=a.length;switch(n.key){case"ArrowUp":n.preventDefault(),u==="none"?h>0&&(u="history",c=0):u==="history"?c<h-1&&c++:u==="saved"&&(c===0?(u="none",c=-1):c--),E(r,a);break;case"ArrowDown":n.preventDefault(),u==="none"?b>0&&(u="saved",c=0):u==="history"?c>0?c--:(u="none",c=-1):u==="saved"&&c<b-1&&c++,E(r,a);break;case"Enter":n.preventDefault();const l=t.value.trim();if($(l)){window.location.href=K(l);return}u==="history"&&p[c]?window.location.href=p[c].url:u==="saved"&&f[c]?window.location.href=f[c].url:l&&(window.location.href=`https://www.google.com/search?q=${encodeURIComponent(l)}`);break;case"Escape":t.value="",x(""),u="none",c=-1;break}}),s.addEventListener("click",n=>{const r=n.target.closest(".newtab-history-item");if(r){const a=r.dataset.url;a&&(window.location.href=a)}}),e.addEventListener("click",n=>{const r=n.target.closest(".newtab-result-item");if(r){const a=r.dataset.url;a&&(window.location.href=a)}})}function $(t){return t.includes(" ")?!1:!!(/^https?:\/\//i.test(t)||/^[a-zA-Z0-9]([a-zA-Z0-9-]*[a-zA-Z0-9])?(\.[a-zA-Z]{2,})+/.test(t)||/^(localhost|(\d{1,3}\.){3}\d{1,3})(:\d+)?/.test(t))}function K(t){return/^https?:\/\//i.test(t)?t:`https://${t}`}async function x(t){const e=document.getElementById("results-tray"),s=document.getElementById("results-list"),o=document.getElementById("results-count"),i=document.getElementById("results-header"),n=document.getElementById("history-tray"),r=document.getElementById("history-list"),a=document.getElementById("search-hint");if(u="none",c=-1,!t||t.length<1){e.classList.remove("visible"),n.classList.remove("visible"),a.innerHTML="<kbd>↵</kbd> Google",f=[],p=[];return}if($(t)){e.classList.remove("visible"),n.classList.remove("visible"),a.innerHTML="<kbd>↵</kbd> Go to site",f=[],p=[];return}try{const l=await chrome.history.search({text:t,maxResults:50,startTime:Date.now()-2592e6});if(l.length>0){const m=new Map;for(const d of l){if(!d.url||!d.title)continue;const v=m.get(d.url);v?(v.count+=d.visitCount||1,d.lastVisitTime&&d.lastVisitTime>v.lastVisitTime&&(v.lastVisitTime=d.lastVisitTime,v.item=d)):m.set(d.url,{item:d,count:d.visitCount||1,lastVisitTime:d.lastVisitTime||0})}p=Array.from(m.values()).sort((d,v)=>v.lastVisitTime-d.lastVisitTime).slice(0,5).map(({item:d,count:v,lastVisitTime:k})=>({id:d.id||String(Date.now()),title:d.title||d.url||"",url:d.url||"",domain:T(d.url||""),visitTime:k?H(k):"",visitCount:v}));const B=[...p].reverse();r.innerHTML=B.map((d,v)=>j(d,v)).join(""),n.classList.add("visible"),requestAnimationFrame(()=>{r.scrollTop=r.scrollHeight})}else n.classList.remove("visible"),p=[]}catch(l){console.error("Error searching history:",l),n.classList.remove("visible"),p=[]}const h=t.toLowerCase(),b=M.filter(l=>{var m;return l.title.toLowerCase().includes(h)||l.url.toLowerCase().includes(h)||((m=l.searchText)==null?void 0:m.toLowerCase().includes(h))}).slice(0,6);b.length>0?(f=b.map(l=>({id:l.id,title:l.title,url:l.url,favicon:l.favicon,domain:T(l.url),savedAt:H(l.savedAt),topics:I.filter(m=>l.topicIds.includes(m.id)),intents:S.filter(m=>l.intentIds.includes(m.id))})),o.textContent=String(b.length),s.innerHTML=f.map((l,m)=>O(l,m)).join(""),i.style.display="flex",e.classList.add("visible")):(e.classList.remove("visible"),f=[]),p.length>0&&f.length>0?a.innerHTML="<kbd>↑</kbd> history &nbsp; <kbd>↓</kbd> saved &nbsp; <kbd>↵</kbd> open":p.length>0?a.innerHTML="<kbd>↑</kbd> history &nbsp; <kbd>↵</kbd> open or Google":f.length>0?a.innerHTML="<kbd>↓</kbd> saved &nbsp; <kbd>↵</kbd> open or Google":a.innerHTML="<kbd>↵</kbd> Google"}function j(t,e){const s=t.visitCount>1?`<span class="newtab-history-visits">${t.visitCount}×</span>`:"";return`
    <div class="newtab-history-item" data-url="${g(t.url)}" data-index="${e}" data-section="history">
      <div class="newtab-history-favicon">
        ${t.domain[0].toUpperCase()}
      </div>
      <div class="newtab-history-content">
        <div class="newtab-history-title">${g(t.title)}</div>
        <div class="newtab-history-meta">
          <span class="newtab-history-domain">${g(t.domain)}</span>
          ${t.visitTime?`<span class="newtab-history-separator">•</span><span class="newtab-history-time">${t.visitTime}</span>`:""}
          ${s}
        </div>
      </div>
    </div>
  `}function O(t,e){const s=t.favicon?`<img src="${g(t.favicon)}" alt="" onerror="this.style.display='none';this.parentElement.textContent='${t.domain[0].toUpperCase()}'">`:t.domain[0].toUpperCase();return`
    <div class="newtab-result-item" data-url="${g(t.url)}" data-index="${e}" data-section="saved">
      <div class="newtab-result-favicon">
        ${s}
      </div>
      <div class="newtab-result-content">
        <div class="newtab-result-title">${g(t.title)}</div>
        <div class="newtab-result-meta">
          <span class="newtab-result-domain">${g(t.domain)}</span>
          <span class="newtab-result-separator">•</span>
          <span class="newtab-result-time">${t.savedAt}</span>
        </div>
      </div>
      <div class="newtab-result-tags">
        ${t.topics.slice(0,2).map(o=>`
          <span class="newtab-result-tag" style="background: ${Z(o.color,.15)}; color: ${o.color};">
            ${g(o.name)}
          </span>
        `).join("")}
      </div>
    </div>
  `}function E(t,e){var s,o,i,n;if(t.forEach(r=>r.classList.remove("selected")),e.forEach(r=>r.classList.remove("selected")),u!=="none")if(u==="history"&&c>=0){const r=t.length-1-c;(s=t[r])==null||s.classList.add("selected"),(o=t[r])==null||o.scrollIntoView({block:"nearest"})}else u==="saved"&&c>=0&&((i=e[c])==null||i.classList.add("selected"),(n=e[c])==null||n.scrollIntoView({block:"nearest"}))}function T(t){try{return new URL(t).hostname.replace("www.","")}catch{return t}}function H(t){const e=Math.floor((Date.now()-t)/1e3);if(e<60)return"Just now";const s=Math.floor(e/60);if(s<60)return`${s}m ago`;const o=Math.floor(s/60);if(o<24)return`${o}h ago`;const i=Math.floor(o/24);if(i<7)return`${i}d ago`;const n=Math.floor(i/7);if(n<4)return`${n}w ago`;const r=Math.floor(i/30);return r<12?`${r}mo ago`:`${Math.floor(i/365)}y ago`}function g(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}function Z(t,e){const s=parseInt(t.slice(1,3),16),o=parseInt(t.slice(3,5),16),i=parseInt(t.slice(5,7),16);return`rgba(${s}, ${o}, ${i}, ${e})`}
